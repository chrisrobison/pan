<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PAN Demo Suite · 08 Workers</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./assets/grail.css">
</head>
<body>
  <pan-bus></pan-bus>
  <div class="app-shell">
    <aside class="sidebar">
      <div class="brand">
        <span class="dot"></span>
        <span>PAN Demo Suite</span>
      </div>
      <nav class="nav-content">
        <a class="nav-item" href="./01-hello.html"><span>Hello Counter</span><span class="hint">01</span></a>
        <a class="nav-item" href="./02-todos-and-inspector.html"><span>Todos + Inspector</span><span class="hint">02</span></a>
        <a class="nav-item" href="./03-broadcastchannel.html"><span>Cross-tab Sync</span><span class="hint">03</span></a>
        <a class="nav-item" href="./04-react-wrapper.html"><span>React Wrapper</span><span class="hint">04</span></a>
        <a class="nav-item" href="./05-lit-wrapper.html"><span>Lit Wrapper</span><span class="hint">05</span></a>
        <a class="nav-item" href="./06-crud.html"><span>CRUD (Mock Provider)</span><span class="hint">06</span></a>
        <a class="nav-item" href="./07-rest-connector.html"><span>REST Connector</span><span class="hint">07</span></a>
        <a class="nav-item active" aria-current="page" href="./08-workers.html"><span>Workers</span><span class="hint">08</span></a>
      </nav>
      <div class="sidebar-footer">
        Offload heavy transforms to a Worker and stream results back via <code>pan-worker</code>.
      </div>
    </aside>

    <main class="main-region">
      <header class="main-header">
        <h1>Worker-powered Querying</h1>
        <p>
          Filter and sort 10k synthetic records inside a Web Worker. The query component orchestrates parameters and the worker publishes retained list state.
        </p>
        <div class="badge-row">
          <span class="badge">topics: <code>users.list.*</code></span>
          <span class="badge">pan-worker bridge</span>
          <span class="badge">URL sync</span>
        </div>
      </header>

      <section class="content-area">
        <div class="split-vertical">
          <section class="panel">
            <div class="panel-header">
              <div>
                <h2>10k Users</h2>
                <div class="subtitle">Worker handles filter/sort; <code>pan-query</code> syncs inputs.</div>
              </div>
            </div>
            <div class="panel-body">
              <pan-query resource="users" sync-url="search">
                <script type="application/json">{"q":"","sort":"name:asc","page":1,"size":100}</script>
              </pan-query>
              <div style="display:flex;gap:0.75rem;align-items:center;margin-bottom:1rem;flex-wrap:wrap;">
                <input id="q" placeholder="Filter (name/email)…" style="flex:1;min-width:200px;padding:0.65rem 0.75rem;border-radius:0.8rem;border:1px solid rgba(15,23,42,0.12);" />
                <select id="sort" style="padding:0.65rem 0.75rem;border-radius:0.8rem;border:1px solid rgba(15,23,42,0.12);">
                  <option value="name:asc">Name ↑</option>
                  <option value="name:desc">Name ↓</option>
                  <option value="email:asc">Email ↑</option>
                  <option value="email:desc">Email ↓</option>
                </select>
                <button id="apply" class="button-link" type="button" style="padding:0.55rem 1.1rem;">Apply</button>
                <span style="flex:1;color:var(--color-muted);font-size:0.85rem;">Computation runs inside a worker.</span>
              </div>
              <pan-data-table resource="users" columns="id,name,email"></pan-data-table>
            </div>
          </section>

          <section class="panel">
            <div class="panel-header">
              <div>
                <h2>Traffic</h2>
                <div class="subtitle">Observe list state snapshots and query updates.</div>
              </div>
            </div>
            <div class="panel-body">
              <pan-inspector></pan-inspector>
            </div>
          </section>
        </div>
      </section>
    </main>
  </div>

  <pan-worker topics="users.list.get users.query.set">
    <script type="application/worker">
      let items = [];
      function synth(count = 10000) {
        const out = new Array(count);
        for (let i = 0; i < count; i++) {
          const id = `u${i + 1}`;
          const name = `User ${String(i + 1).padStart(5, '0')}`;
          out[i] = { id, name, email: `${name.toLowerCase().replace(/\s+/g, '')}@example.com` };
        }
        return out;
      }
      items = synth(10000);
      let q = { q: '', sort: 'name:asc' };
      function publish() {
        const [key, dir] = (q.sort || 'name:asc').split(':');
        const search = (q.q || '').toLowerCase();
        let view = items;
        if (search) {
          view = view.filter((it) =>
            String(it.name).toLowerCase().includes(search) ||
            String(it.email).toLowerCase().includes(search)
          );
        }
        view = view.slice().sort((a, b) => {
          const av = a[key], bv = b[key];
          return (av > bv ? 1 : av < bv ? -1 : 0) * (dir === 'desc' ? -1 : 1);
        });
        postMessage({ topic: 'users.list.state', data: { items: view }, retain: true });
      }
      onmessage = (ev) => {
        const m = ev.data || {};
        if (m.topic === 'users.query.set') { q = Object.assign({}, q, m.data || {}); publish(); }
        if (m.topic === 'users.list.get') { publish(); }
      };
    </script>
  </pan-worker>

  <script type="module">
    import '../dist/pan-bus.js';
    import '../dist/pan-client.js';
    import '../dist/pan-inspector.js';
    import '../dist/pan-data-table.js';
    import '../dist/pan-query.js';
    import '../dist/pan-worker.js';
    import { PanClient } from '../dist/pan-client.js';

    const pc = new PanClient();
    const $ = (selector) => document.querySelector(selector);
    const apply = () => pc.publish({ topic: 'users.query.set', data: { q: $('#q').value, sort: $('#sort').value } });

    $('#apply')?.addEventListener('click', () => apply());
    $('#q')?.addEventListener('keydown', (e) => { if (e.key === 'Enter') apply(); });
    $('#q')?.focus();
    if ($('#sort')) $('#sort').value = 'name:asc';
  </script>
</body>
</html>
