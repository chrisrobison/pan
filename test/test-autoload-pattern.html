<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LARC Build Test - Autoload Pattern</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 0 20px;
    }
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    #output {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 4px;
      min-height: 100px;
      margin-top: 20px;
    }
    pan-card {
      display: block;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <h1>LARC Build Test - Autoload Pattern</h1>
  <p>Testing autoload from dist/ (zero-build CDN pattern)</p>

  <div id="status"></div>
  <div id="output"></div>

  <!-- Test components - these should be autoloaded -->
  <pan-card>
    <h3 slot="header">Test Card</h3>
    <p>This card should be autoloaded from dist/ui/pan-card.js</p>
  </pan-card>

  <!-- Configure autoload before loading the script -->
  <script type="module">
    // Configure autoload to load from dist/
    window.panAutoload = {
      componentsPath: '../dist/',
      extension: '.js'
    };
  </script>

  <!-- Load autoload script from dist -->
  <script type="module" src="../dist/autoload.js"></script>

  <!-- Test script -->
  <script type="module">
    import { PanClient } from '../dist/index.js';

    const output = document.getElementById('output');
    const status = document.getElementById('status');

    function log(message) {
      const div = document.createElement('div');
      div.textContent = `[${new Date().toISOString().split('T')[1].split('.')[0]}] ${message}`;
      div.style.marginBottom = '5px';
      output.appendChild(div);
      console.log(message);
    }

    function setStatus(message, success = true) {
      status.innerHTML = `<div class="status ${success ? 'success' : 'error'}">${message}</div>`;
    }

    async function runTests() {
      try {
        log('Starting autoload tests...');

        // Wait for autoload to initialize
        await new Promise(resolve => setTimeout(resolve, 500));

        // Test 1: Check if pan-bus was created by autoload
        const bus = document.querySelector('pan-bus');
        if (bus) {
          log('✓ pan-bus was created by autoload');
        } else {
          throw new Error('pan-bus not found');
        }

        // Test 2: Check if pan-card was loaded
        await customElements.whenDefined('pan-card');
        log('✓ pan-card component was autoloaded');

        // Test 3: Create client and test messaging
        const client = new PanClient();
        await client.ready();
        log('✓ PanClient connected to bus');

        // Test 4: Pub/sub
        let received = false;
        client.subscribe('autoload.test', (msg) => {
          received = true;
          log(`✓ Received: ${JSON.stringify(msg.data)}`);
        });

        client.pub('autoload.test', { status: 'working', timestamp: Date.now() });

        await new Promise(resolve => setTimeout(resolve, 100));

        if (!received) {
          throw new Error('Message not received');
        }

        // Test 5: Check autoload config
        const config = window.panAutoload?.config;
        if (config) {
          log(`✓ Autoload config: componentsPath=${config.componentsPath}, extension=${config.extension}`);
          log(`✓ Resolved path: ${config.resolvedComponentsPath}`);
        }

        setStatus('✅ All autoload tests passed!', true);
        log('All tests completed successfully!');

      } catch (error) {
        setStatus(`❌ Test failed: ${error.message}`, false);
        log(`ERROR: ${error.message}`);
        console.error(error);
      }
    }

    // Run tests after a short delay to let autoload initialize
    setTimeout(runTests, 1000);
  </script>
</body>
</html>
