{
  "version": 3,
  "sources": ["../../src/components/pan-php-connector.mjs"],
  "sourcesContent": ["// <pan-php-connector> \u2014 Bridge PAN list topics to a PHP endpoint shaped like api.php\n//\n// Listens for `${resource}.list.get`, `${resource}.list.more`, and `${resource}.list.reset`.\n// Proxies to `api-url` with query params: x=get, rsc, start, page_size, fields, filters, id.\n// Publishes aggregated `${resource}.list.state` (retain) and `${resource}.list.meta` (non-retained).\n//\n// Attributes:\n// - resource: table/resource name (e.g., \"Business\")\n// - api-url: endpoint URL (default: \"api.php\")\n// - fields: CSV list of columns to select (optional; default: all/\"*\")\n// - page-size: page size to request (api.php caps to 20)\n// - start-param: name of the paging param (default: \"start\")\n//\n// Notes:\n// - This connector accumulates pages locally and republishes the full aggregated list on `${resource}.list.state`.\n// - `filters` may be provided in requests as a JSON string or an array of { key, value }.\n\nimport { PanClient } from './pan-client.mjs';\n\nexport class PanPhpConnector extends HTMLElement {\n  static get observedAttributes(){ return ['resource','api-url','fields','page-size','start-param']; }\n  constructor(){\n    super();\n    this.pc = new PanClient(this);\n    this.items = [];\n    this.meta = { total: null, start: 0, count: 0, page: null };\n    this._offs = [];\n    this._busy = false;\n  }\n\n  connectedCallback(){ this.#rewire(); }\n  disconnectedCallback(){ this.#unsubAll(); }\n  attributeChangedCallback(){ this.#rewire(); }\n\n  get resource(){ return (this.getAttribute('resource') || 'items').trim(); }\n  get apiUrl(){ return (this.getAttribute('api-url') || 'api.php').trim(); }\n  get fields(){ return (this.getAttribute('fields') || '').trim(); }\n  get pageSize(){ const n = Number(this.getAttribute('page-size')); return Number.isFinite(n) && n > 0 ? n : 20; }\n  get startParam(){ return (this.getAttribute('start-param') || 'start').trim(); }\n\n  #rewire(){\n    this.#unsubAll();\n    const r = this.resource;\n    this._offs.push(this.pc.subscribe(`${r}.list.get`, (m)=> this.#onListGet(m)));\n    this._offs.push(this.pc.subscribe(`${r}.list.more`, (m)=> this.#onListMore(m)));\n    this._offs.push(this.pc.subscribe(`${r}.list.reset`, ()=> this.#resetAndFetch()));\n  }\n\n  #unsubAll(){ try { this._offs.forEach(f=>f&&f()); } catch {} this._offs = []; }\n\n  async #onListGet(m){\n    // New request; if no explicit start passed, reset before fetching\n    const data = (m && m.data) || {};\n    const hasStart = Object.prototype.hasOwnProperty.call(data, this.startParam);\n    if (!hasStart || (Number(data[this.startParam])||0) === 0 || data.reset) this.#reset();\n    await this.#fetchPage(data);\n    if (m && m.replyTo) this.pc.publish({ topic: m.replyTo, correlationId: m.correlationId, data: { ok: true, items: this.items, meta: this.meta } });\n  }\n\n  async #onListMore(m){\n    const data = (m && m.data) || {};\n    data[this.startParam] = this.meta.start || 0; // continue from current start\n    await this.#fetchPage(data);\n    if (m && m.replyTo) this.pc.publish({ topic: m.replyTo, correlationId: m.correlationId, data: { ok: true, items: this.items, meta: this.meta } });\n  }\n\n  #reset(){ this.items = []; this.meta = { total: null, start: 0, count: 0, page: null }; this.#publishState(); }\n  async #resetAndFetch(){ this.#reset(); await this.#fetchPage({}); }\n\n  #publishState(){\n    // Aggregated list snapshot\n    this.pc.publish({ topic: `${this.resource}.list.state`, data: { items: this.items.slice() }, retain: true });\n    // Latest meta info\n    this.pc.publish({ topic: `${this.resource}.list.meta`, data: Object.assign({}, this.meta) });\n  }\n\n  #buildUrl(params){\n    const qp = new URLSearchParams();\n    qp.set('x', 'get');\n    qp.set('rsc', this.resource);\n    // page size is capped by the PHP\n    qp.set('page_size', String(this.pageSize));\n    const fields = (params && params.fields) ? String(params.fields).trim() : this.fields;\n    if (fields) qp.set('fields', fields);\n    // paging\n    const startVal = Number(params && Object.prototype.hasOwnProperty.call(params, this.startParam) ? params[this.startParam] : this.meta.start || 0) || 0;\n    qp.set(this.startParam, String(startVal));\n    // filters: accept array or JSON string\n    if (params && params.filters != null) {\n      try {\n        const f = Array.isArray(params.filters) ? params.filters : JSON.parse(String(params.filters));\n        qp.set('filters', JSON.stringify(f));\n      } catch { qp.set('filters', String(params.filters)); }\n    }\n    // optional id fetch\n    if (params && params.id != null) qp.set('id', String(params.id));\n    return `${this.apiUrl}?${qp.toString()}`;\n  }\n\n  async #fetchPage(params){\n    if (this._busy) return; this._busy = true;\n    try {\n      const url = this.#buildUrl(params || {});\n      const res = await fetch(url, { credentials: 'same-origin' });\n      if (!res.ok) throw new Error(`HTTP ${res.status}`);\n      const body = await res.json();\n      let rows = [];\n      if (Array.isArray(body)) rows = body;\n      else if (body && Array.isArray(body.results)) rows = body.results;\n      // Append and advance\n      const before = this.items.length;\n      if (rows && rows.length) {\n        this.items.push(...rows);\n        this.meta.start = (this.meta.start || 0) + rows.length;\n        this.meta.count = rows.length;\n      } else {\n        this.meta.count = 0;\n      }\n      // Total / page when provided\n      if (body && typeof body.total !== 'undefined') {\n        const total = (typeof body.total === 'number') ? body.total : Number(body.total);\n        if (Number.isFinite(total)) this.meta.total = total;\n      }\n      if (body && typeof body.page !== 'undefined') {\n        const page = (typeof body.page === 'number') ? body.page : Number(body.page);\n        if (Number.isFinite(page)) this.meta.page = page;\n      }\n      // Publish state if anything changed\n      if (this.items.length !== before || this.meta.count === 0) this.#publishState();\n    } catch (e) {\n      // On error, still publish current state and meta with error info\n      this.pc.publish({ topic: `${this.resource}.list.meta`, data: Object.assign({}, this.meta, { error: String(e && e.message || e) }) });\n    } finally { this._busy = false; }\n  }\n}\n\ncustomElements.define('pan-php-connector', PanPhpConnector);\nexport default PanPhpConnector;\n\n"],
  "mappings": "AAiBA,SAAS,iBAAiB;AAEnB,MAAM,wBAAwB,YAAY;AAAA,EAC/C,WAAW,qBAAoB;AAAE,WAAO,CAAC,YAAW,WAAU,UAAS,aAAY,aAAa;AAAA,EAAG;AAAA,EACnG,cAAa;AACX,UAAM;AACN,SAAK,KAAK,IAAI,UAAU,IAAI;AAC5B,SAAK,QAAQ,CAAC;AACd,SAAK,OAAO,EAAE,OAAO,MAAM,OAAO,GAAG,OAAO,GAAG,MAAM,KAAK;AAC1D,SAAK,QAAQ,CAAC;AACd,SAAK,QAAQ;AAAA,EACf;AAAA,EAEA,oBAAmB;AAAE,SAAK,QAAQ;AAAA,EAAG;AAAA,EACrC,uBAAsB;AAAE,SAAK,UAAU;AAAA,EAAG;AAAA,EAC1C,2BAA0B;AAAE,SAAK,QAAQ;AAAA,EAAG;AAAA,EAE5C,IAAI,WAAU;AAAE,YAAQ,KAAK,aAAa,UAAU,KAAK,SAAS,KAAK;AAAA,EAAG;AAAA,EAC1E,IAAI,SAAQ;AAAE,YAAQ,KAAK,aAAa,SAAS,KAAK,WAAW,KAAK;AAAA,EAAG;AAAA,EACzE,IAAI,SAAQ;AAAE,YAAQ,KAAK,aAAa,QAAQ,KAAK,IAAI,KAAK;AAAA,EAAG;AAAA,EACjE,IAAI,WAAU;AAAE,UAAM,IAAI,OAAO,KAAK,aAAa,WAAW,CAAC;AAAG,WAAO,OAAO,SAAS,CAAC,KAAK,IAAI,IAAI,IAAI;AAAA,EAAI;AAAA,EAC/G,IAAI,aAAY;AAAE,YAAQ,KAAK,aAAa,aAAa,KAAK,SAAS,KAAK;AAAA,EAAG;AAAA,EAE/E,UAAS;AACP,SAAK,UAAU;AACf,UAAM,IAAI,KAAK;AACf,SAAK,MAAM,KAAK,KAAK,GAAG,UAAU,GAAG,CAAC,aAAa,CAAC,MAAK,KAAK,WAAW,CAAC,CAAC,CAAC;AAC5E,SAAK,MAAM,KAAK,KAAK,GAAG,UAAU,GAAG,CAAC,cAAc,CAAC,MAAK,KAAK,YAAY,CAAC,CAAC,CAAC;AAC9E,SAAK,MAAM,KAAK,KAAK,GAAG,UAAU,GAAG,CAAC,eAAe,MAAK,KAAK,eAAe,CAAC,CAAC;AAAA,EAClF;AAAA,EAEA,YAAW;AAAE,QAAI;AAAE,WAAK,MAAM,QAAQ,OAAG,KAAG,EAAE,CAAC;AAAA,IAAG,QAAQ;AAAA,IAAC;AAAE,SAAK,QAAQ,CAAC;AAAA,EAAG;AAAA,EAE9E,MAAM,WAAW,GAAE;AAEjB,UAAM,OAAQ,KAAK,EAAE,QAAS,CAAC;AAC/B,UAAM,WAAW,OAAO,UAAU,eAAe,KAAK,MAAM,KAAK,UAAU;AAC3E,QAAI,CAAC,aAAa,OAAO,KAAK,KAAK,UAAU,CAAC,KAAG,OAAO,KAAK,KAAK,MAAO,MAAK,OAAO;AACrF,UAAM,KAAK,WAAW,IAAI;AAC1B,QAAI,KAAK,EAAE,QAAS,MAAK,GAAG,QAAQ,EAAE,OAAO,EAAE,SAAS,eAAe,EAAE,eAAe,MAAM,EAAE,IAAI,MAAM,OAAO,KAAK,OAAO,MAAM,KAAK,KAAK,EAAE,CAAC;AAAA,EAClJ;AAAA,EAEA,MAAM,YAAY,GAAE;AAClB,UAAM,OAAQ,KAAK,EAAE,QAAS,CAAC;AAC/B,SAAK,KAAK,UAAU,IAAI,KAAK,KAAK,SAAS;AAC3C,UAAM,KAAK,WAAW,IAAI;AAC1B,QAAI,KAAK,EAAE,QAAS,MAAK,GAAG,QAAQ,EAAE,OAAO,EAAE,SAAS,eAAe,EAAE,eAAe,MAAM,EAAE,IAAI,MAAM,OAAO,KAAK,OAAO,MAAM,KAAK,KAAK,EAAE,CAAC;AAAA,EAClJ;AAAA,EAEA,SAAQ;AAAE,SAAK,QAAQ,CAAC;AAAG,SAAK,OAAO,EAAE,OAAO,MAAM,OAAO,GAAG,OAAO,GAAG,MAAM,KAAK;AAAG,SAAK,cAAc;AAAA,EAAG;AAAA,EAC9G,MAAM,iBAAgB;AAAE,SAAK,OAAO;AAAG,UAAM,KAAK,WAAW,CAAC,CAAC;AAAA,EAAG;AAAA,EAElE,gBAAe;AAEb,SAAK,GAAG,QAAQ,EAAE,OAAO,GAAG,KAAK,QAAQ,eAAe,MAAM,EAAE,OAAO,KAAK,MAAM,MAAM,EAAE,GAAG,QAAQ,KAAK,CAAC;AAE3G,SAAK,GAAG,QAAQ,EAAE,OAAO,GAAG,KAAK,QAAQ,cAAc,MAAM,OAAO,OAAO,CAAC,GAAG,KAAK,IAAI,EAAE,CAAC;AAAA,EAC7F;AAAA,EAEA,UAAU,QAAO;AACf,UAAM,KAAK,IAAI,gBAAgB;AAC/B,OAAG,IAAI,KAAK,KAAK;AACjB,OAAG,IAAI,OAAO,KAAK,QAAQ;AAE3B,OAAG,IAAI,aAAa,OAAO,KAAK,QAAQ,CAAC;AACzC,UAAM,SAAU,UAAU,OAAO,SAAU,OAAO,OAAO,MAAM,EAAE,KAAK,IAAI,KAAK;AAC/E,QAAI,OAAQ,IAAG,IAAI,UAAU,MAAM;AAEnC,UAAM,WAAW,OAAO,UAAU,OAAO,UAAU,eAAe,KAAK,QAAQ,KAAK,UAAU,IAAI,OAAO,KAAK,UAAU,IAAI,KAAK,KAAK,SAAS,CAAC,KAAK;AACrJ,OAAG,IAAI,KAAK,YAAY,OAAO,QAAQ,CAAC;AAExC,QAAI,UAAU,OAAO,WAAW,MAAM;AACpC,UAAI;AACF,cAAM,IAAI,MAAM,QAAQ,OAAO,OAAO,IAAI,OAAO,UAAU,KAAK,MAAM,OAAO,OAAO,OAAO,CAAC;AAC5F,WAAG,IAAI,WAAW,KAAK,UAAU,CAAC,CAAC;AAAA,MACrC,QAAQ;AAAE,WAAG,IAAI,WAAW,OAAO,OAAO,OAAO,CAAC;AAAA,MAAG;AAAA,IACvD;AAEA,QAAI,UAAU,OAAO,MAAM,KAAM,IAAG,IAAI,MAAM,OAAO,OAAO,EAAE,CAAC;AAC/D,WAAO,GAAG,KAAK,MAAM,IAAI,GAAG,SAAS,CAAC;AAAA,EACxC;AAAA,EAEA,MAAM,WAAW,QAAO;AACtB,QAAI,KAAK,MAAO;AAAQ,SAAK,QAAQ;AACrC,QAAI;AACF,YAAM,MAAM,KAAK,UAAU,UAAU,CAAC,CAAC;AACvC,YAAM,MAAM,MAAM,MAAM,KAAK,EAAE,aAAa,cAAc,CAAC;AAC3D,UAAI,CAAC,IAAI,GAAI,OAAM,IAAI,MAAM,QAAQ,IAAI,MAAM,EAAE;AACjD,YAAM,OAAO,MAAM,IAAI,KAAK;AAC5B,UAAI,OAAO,CAAC;AACZ,UAAI,MAAM,QAAQ,IAAI,EAAG,QAAO;AAAA,eACvB,QAAQ,MAAM,QAAQ,KAAK,OAAO,EAAG,QAAO,KAAK;AAE1D,YAAM,SAAS,KAAK,MAAM;AAC1B,UAAI,QAAQ,KAAK,QAAQ;AACvB,aAAK,MAAM,KAAK,GAAG,IAAI;AACvB,aAAK,KAAK,SAAS,KAAK,KAAK,SAAS,KAAK,KAAK;AAChD,aAAK,KAAK,QAAQ,KAAK;AAAA,MACzB,OAAO;AACL,aAAK,KAAK,QAAQ;AAAA,MACpB;AAEA,UAAI,QAAQ,OAAO,KAAK,UAAU,aAAa;AAC7C,cAAM,QAAS,OAAO,KAAK,UAAU,WAAY,KAAK,QAAQ,OAAO,KAAK,KAAK;AAC/E,YAAI,OAAO,SAAS,KAAK,EAAG,MAAK,KAAK,QAAQ;AAAA,MAChD;AACA,UAAI,QAAQ,OAAO,KAAK,SAAS,aAAa;AAC5C,cAAM,OAAQ,OAAO,KAAK,SAAS,WAAY,KAAK,OAAO,OAAO,KAAK,IAAI;AAC3E,YAAI,OAAO,SAAS,IAAI,EAAG,MAAK,KAAK,OAAO;AAAA,MAC9C;AAEA,UAAI,KAAK,MAAM,WAAW,UAAU,KAAK,KAAK,UAAU,EAAG,MAAK,cAAc;AAAA,IAChF,SAAS,GAAG;AAEV,WAAK,GAAG,QAAQ,EAAE,OAAO,GAAG,KAAK,QAAQ,cAAc,MAAM,OAAO,OAAO,CAAC,GAAG,KAAK,MAAM,EAAE,OAAO,OAAO,KAAK,EAAE,WAAW,CAAC,EAAE,CAAC,EAAE,CAAC;AAAA,IACrI,UAAE;AAAU,WAAK,QAAQ;AAAA,IAAO;AAAA,EAClC;AACF;AAEA,eAAe,OAAO,qBAAqB,eAAe;AAC1D,IAAO,4BAAQ;",
  "names": []
}
