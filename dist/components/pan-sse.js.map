{
  "version": 3,
  "sources": ["../../pan/components/pan-sse.mjs"],
  "sourcesContent": ["// <pan-sse> \u2014 Bridge Server-Sent Events to PAN bus\n// Attributes:\n//   - src: SSE endpoint URL\n//   - topics: optional space-sep list; appended as ?topics=...\n//   - with-credentials: include credentials on EventSource\n//   - persist-last-event: localStorage key to store lastEventId and pass as ?lastEventId\n//   - backoff: min,max in ms (e.g., \"1000,15000\"); jittered reconnect\n\nimport { PanClient } from './pan-client.mjs';\n\nexport class PanSSE extends HTMLElement {\n  static get observedAttributes(){ return ['src','topics','with-credentials','persist-last-event','backoff']; }\n  constructor(){ super(); this.pc = new PanClient(this); this.es=null; this._stopped=false; this._timer=null; }\n  connectedCallback(){ this.#start(); }\n  disconnectedCallback(){ this._stopped=true; this.#stop(); }\n  attributeChangedCallback(){ this.#restart(); }\n\n  get src(){ return (this.getAttribute('src')||'').trim(); }\n  get topics(){ const t=(this.getAttribute('topics')||'').trim(); return t? t.split(/\\s+/): []; }\n  get withCredentials(){ return (this.getAttribute('with-credentials')||'').toLowerCase() !== 'false'; }\n  get persistKey(){ return (this.getAttribute('persist-last-event')||'').trim(); }\n  get backoff(){ const s=(this.getAttribute('backoff')||'1000,15000').split(',').map(x=>Number(x)||0); const [min,max]=[Math.max(100,s[0]||1000), Math.max(s[1]||s[0]||5000, s[0]||1000)]; return {min,max}; }\n\n  #restart(){ this.#stop(); this.#start(); }\n  #stop(){ try{ this.es && this.es.close(); }catch{} this.es=null; if (this._timer) { clearTimeout(this._timer); this._timer=null; } }\n\n  #url(){\n    let url = this.src; if (!url) return '';\n    const u = new URL(url, location.origin);\n    if (this.topics.length) u.searchParams.set('topics', this.topics.join(','));\n    if (this.persistKey) {\n      try { const last = localStorage.getItem(`pan:sse:last:${this.persistKey}`); if (last) u.searchParams.set('lastEventId', last); } catch {}\n    }\n    return u.toString();\n  }\n\n  #start(){\n    if (!this.src || this._stopped) return;\n    const url = this.#url(); if (!url) return;\n    const es = new EventSource(url, { withCredentials: this.withCredentials });\n    this.es = es;\n    const onMsg = (ev)=>{\n      const lastId = ev.lastEventId; if (lastId && this.persistKey) { try { localStorage.setItem(`pan:sse:last:${this.persistKey}`, lastId); } catch {} }\n      let topic = ev.type && ev.type !== 'message' ? ev.type : '';\n      try {\n        const data = ev.data ? JSON.parse(ev.data) : null;\n        if (!topic) topic = data?.topic || '';\n        if (!topic) return;\n        const out = { topic, data: data?.data ?? data?.payload ?? (data?.item ? { item: data.item } : data) };\n        if (data && typeof data.retain === 'boolean') out.retain = data.retain;\n        this.pc.publish(out);\n      } catch {\n        if (topic) this.pc.publish({ topic, data: { raw: ev.data } });\n      }\n    };\n    const onErr = ()=>{ this.#scheduleReconnect(); };\n    es.addEventListener('message', onMsg);\n    es.addEventListener('error', onErr);\n    // Also handle named events as topics if server emits `event: <topic>`\n    // We can't pre-register unknown names; rely on default 'message' and JSON.topic for most cases.\n  }\n\n  #scheduleReconnect(){\n    if (this._stopped) return;\n    this.#stop();\n    const {min,max} = this.backoff; const ms = Math.min(max, Math.round(min + Math.random()*(max-min)));\n    this._timer = setTimeout(()=> this.#start(), ms);\n  }\n}\n\ncustomElements.define('pan-sse', PanSSE);\nexport default PanSSE;\n\n"],
  "mappings": "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",
  "names": []
}
