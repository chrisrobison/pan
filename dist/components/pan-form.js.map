{
  "version": 3,
  "sources": ["../../pan/components/pan-form.mjs"],
  "sourcesContent": ["// <pan-form> \u2014 Basic CRUD form for a named resource.\n// Listens for `${resource}.item.select`, requests `${resource}.item.get`,\n// and submits via `${resource}.item.save` / deletes via `${resource}.item.delete`.\n\nimport { PanClient } from './pan-client.mjs';\n\nexport class PanForm extends HTMLElement {\n  static get observedAttributes(){ return ['resource','fields','key','live']; }\n  constructor(){ super(); this.attachShadow({mode:'open'}); this.pc = new PanClient(this); this.value = {}; this._offSel=null; this._offLive=null; this._selectedId=null; this._liveTopic=null; }\n  connectedCallback(){ this.render(); this.#wire(); }\n  disconnectedCallback(){ this._unsubAll(); }\n  attributeChangedCallback(){ this.render(); this.#wire(); }\n\n  get resource(){ return (this.getAttribute('resource')||'items').trim(); }\n  get fields(){ const f=(this.getAttribute('fields')||'').trim(); return f? f.split(/\\s*,\\s*/): []; }\n  get key(){ return (this.getAttribute('key')||'id').trim(); }\n  get live(){ const v=(this.getAttribute('live')||'true').toLowerCase(); return v!== 'false' && v!== '0'; }\n\n  #wire(){\n    this._unsubAll();\n    // Listen for selection events\n    this._offSel = this.pc.subscribe(`${this.resource}.item.select`, async (m)=>{\n      const id = m?.data?.id; if (!id) return;\n      this._selectedId = id;\n      this.#subscribeLive();\n      try { const { data } = await this.pc.request(`${this.resource}.item.get`, { id }); this.#setValue(data?.item || {}); }\n      catch { /* ignore */ }\n    });\n    const form = this.shadowRoot.getElementById('f');\n    if (form) form.onsubmit = (e)=>{ e.preventDefault(); this.#save(); };\n    const del = this.shadowRoot.getElementById('del');\n    if (del) del.onclick = (e)=>{ e.preventDefault(); this.#delete(); };\n  }\n\n  _unsubAll(){ try { this._offSel && this._offSel(); } catch {} this._offSel=null; try { this._offLive && this._offLive(); } catch {} this._offLive=null; this._liveTopic=null; }\n\n  #subscribeLive(){\n    if (!this.live) return;\n    const id = this._selectedId || this.value?.[this.key] || this.value?.id; if (!id) return;\n    const topic = `${this.resource}.item.state.${id}`;\n    if (this._liveTopic === topic && this._offLive) return; // already subscribed for this id\n    try { this._offLive && this._offLive(); } catch {} this._offLive = null; this._liveTopic = topic;\n    this._offLive = this.pc.subscribe(topic, (m)=>{\n      const d = m?.data || {};\n      if (d.deleted) {\n        // If this item was deleted elsewhere, clear the form\n        const cur = this.value?.[this.key] || this.value?.id; if (String(cur) === String(id)) this.#setValue({});\n        return;\n      }\n      if (d.item && typeof d.item === 'object') { this.#setValue(d.item); return; }\n      if (d.patch && typeof d.patch === 'object') { this.#setValue(Object.assign({}, this.value||{}, d.patch)); return; }\n      // Fallback: accept top-level fields as patch\n      if (d && typeof d === 'object') { this.#setValue(Object.assign({}, this.value||{}, d)); }\n    }, { retained:true });\n  }\n\n  async #save(){\n    const item = this.#collect();\n    try {\n      const { data } = await this.pc.request(`${this.resource}.item.save`, { item });\n      const saved = data?.item || item; this.#setValue(saved);\n      this._selectedId = saved?.[this.key] || saved?.id || this._selectedId; this.#subscribeLive();\n    } catch {}\n  }\n\n  async #delete(){\n    const id = this.value?.id || this.value?.[this.key];\n    if (!id) return;\n    try {\n      await this.pc.request(`${this.resource}.item.delete`, { id });\n      this.#setValue({});\n    } catch {}\n  }\n\n  #collect(){\n    const out = Object.assign({}, this.value);\n    for (const name of this.fields){\n      const input = this.shadowRoot.querySelector(`[name=\"${name}\"]`);\n      if (!input) continue;\n      const v = input.value;\n      out[name] = v;\n    }\n    return out;\n  }\n\n  #setValue(v){ this.value = v || {}; this.render(); this.#wire(); }\n\n  render(){\n    const h = String.raw; const v = this.value || {};\n    this.shadowRoot.innerHTML = h`\n      <style>\n        :host{display:block; border:1px solid #ddd; border-radius:8px; padding:12px; font:13px/1.4 system-ui, sans-serif}\n        form{ display:grid; gap:8px }\n        label{ display:grid; gap:4px }\n        input,button{ padding:8px 10px }\n        .row{ display:flex; gap:8px; align-items:center }\n        .spacer{ flex:1 }\n      </style>\n      <form id=\"f\">\n        ${this.fields.map(name=>`\n          <label>\n            <span>${name}</span>\n            <input name=\"${name}\" value=\"${this.#escape(v[name] ?? '')}\" />\n          </label>`).join('')}\n        <div class=\"row\">\n          <button id=\"save\" type=\"submit\">Save</button>\n          <span class=\"spacer\"></span>\n          <button id=\"del\" type=\"button\">Delete</button>\n        </div>\n      </form>\n    `;\n    // If a value is already present, ensure live subscription is set\n    this.#subscribeLive();\n  }\n\n  #escape(s){ return String(s).replace(/[&<>\"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\\'':'&#39;'}[c])); }\n}\n\ncustomElements.define('pan-form', PanForm);\nexport default PanForm;\n"],
  "mappings": "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",
  "names": []
}
