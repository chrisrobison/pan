{
  "version": 3,
  "sources": ["../../src/components/pan-fetch.mjs"],
  "sourcesContent": ["/**\n * pan-fetch - Authenticated fetch() wrapper\n *\n * Provides a fetch() wrapper that automatically injects Authorization headers\n * based on auth.internal.state from pan-auth\n *\n * @example\n * import { panFetch } from './pan/components/pan-fetch.mjs';\n *\n * // Automatically includes auth header if user is logged in\n * const response = await panFetch('/api/users');\n * const data = await response.json();\n *\n * // You can override headers if needed\n * const response = await panFetch('/api/public', {\n *   headers: { 'X-Custom': 'value' }\n * });\n */\n\nimport { PanClient } from './pan-client.mjs';\n\nclass PanFetch {\n  constructor() {\n    this.pc = new PanClient();\n    this.authState = null;\n\n    // Subscribe to auth state\n    this.pc.subscribe('auth.internal.state', (msg) => {\n      this.authState = msg.data;\n    }, { retained: true });\n  }\n\n  /**\n   * Fetch with automatic auth header injection\n   * @param {string|Request} input - URL or Request object\n   * @param {RequestInit} init - fetch options\n   * @returns {Promise<Response>}\n   */\n  async fetch(input, init = {}) {\n    // Clone init to avoid mutation\n    const options = { ...init };\n\n    // Merge headers\n    options.headers = new Headers(options.headers || {});\n\n    // SECURITY: Use HttpOnly cookies for auth (credentials: 'include')\n    // Tokens are sent automatically in cookies, no need to expose in JS\n    if (!options.credentials) {\n      options.credentials = 'include'; // Send cookies with request\n    }\n\n    // Legacy: Manual Authorization header (NOT RECOMMENDED - use HttpOnly cookies)\n    if (this.authState?.authenticated && this.authState?.token) {\n      // Only add if not already present\n      if (!options.headers.has('Authorization')) {\n        options.headers.set('Authorization', `Bearer ${this.authState.token}`);\n        console.warn('\u26A0 Using token from localStorage - vulnerable to XSS. Use HttpOnly cookies instead.');\n      }\n    }\n\n    return fetch(input, options);\n  }\n\n  /**\n   * Convenience method for JSON requests\n   * @param {string} url - URL to fetch\n   * @param {RequestInit} init - fetch options\n   * @returns {Promise<any>} - Parsed JSON response\n   */\n  async fetchJson(url, init = {}) {\n    const options = { ...init };\n\n    // Ensure Content-Type is set for JSON\n    options.headers = new Headers(options.headers || {});\n    if (!options.headers.has('Content-Type')) {\n      options.headers.set('Content-Type', 'application/json');\n    }\n\n    const response = await this.fetch(url, options);\n\n    if (!response.ok) {\n      const error = new Error(`HTTP ${response.status}: ${response.statusText}`);\n      error.status = response.status;\n      error.response = response;\n      try {\n        error.data = await response.json();\n      } catch {\n        error.data = await response.text();\n      }\n      throw error;\n    }\n\n    return response.json();\n  }\n\n  /**\n   * GET request with JSON response\n   */\n  async get(url, init = {}) {\n    return this.fetchJson(url, { ...init, method: 'GET' });\n  }\n\n  /**\n   * POST request with JSON body and response\n   */\n  async post(url, body, init = {}) {\n    return this.fetchJson(url, {\n      ...init,\n      method: 'POST',\n      body: typeof body === 'string' ? body : JSON.stringify(body)\n    });\n  }\n\n  /**\n   * PUT request with JSON body and response\n   */\n  async put(url, body, init = {}) {\n    return this.fetchJson(url, {\n      ...init,\n      method: 'PUT',\n      body: typeof body === 'string' ? body : JSON.stringify(body)\n    });\n  }\n\n  /**\n   * PATCH request with JSON body and response\n   */\n  async patch(url, body, init = {}) {\n    return this.fetchJson(url, {\n      ...init,\n      method: 'PATCH',\n      body: typeof body === 'string' ? body : JSON.stringify(body)\n    });\n  }\n\n  /**\n   * DELETE request with JSON response\n   */\n  async delete(url, init = {}) {\n    return this.fetchJson(url, { ...init, method: 'DELETE' });\n  }\n\n  /**\n   * Get current auth state\n   */\n  getAuthState() {\n    return this.authState;\n  }\n\n  /**\n   * Check if user is authenticated\n   */\n  isAuthenticated() {\n    return this.authState?.authenticated === true;\n  }\n}\n\n// Export singleton instance\nexport const panFetch = new PanFetch();\n\n// Also export the class for custom instances\nexport { PanFetch };\n\nexport default panFetch;\n"],
  "mappings": "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",
  "names": []
}
