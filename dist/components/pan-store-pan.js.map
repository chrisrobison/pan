{
  "version": 3,
  "sources": ["../../pan/components/pan-store-pan.mjs"],
  "sourcesContent": ["// Store \u2194 PAN bridge helpers\n// - syncItem: keeps a store in sync with `${resource}.item.state.${id}` and auto-saves changes\n// - syncList: tracks `${resource}.list.state` and granular `${resource}.item.state.*` into an array store\n\nimport { PanClient } from './pan-client.mjs';\n\nexport function syncItem(store, { resource='items', id=null, key='id', live=true, autoSave=true, debounceMs=300, followSelect=true } = {}){\n  const pc = new PanClient();\n  let currentId = id;\n  let offLive = null; let offSel = null; let saving = false; let t = null; let applying = 0;\n\n  function applyItem(item){\n    applying++;\n    try { if (item && typeof item==='object') store._setAll(item); }\n    finally { applying--; }\n  }\n\n  function subscribeLive(){\n    try { offLive && offLive(); } catch {} offLive = null;\n    if (!live || !currentId) return;\n    offLive = pc.subscribe(`${resource}.item.state.${currentId}`, (m)=>{\n      const d = m?.data || {};\n      if (d.deleted) { if (String(currentId) === String(d.id)) applyItem({}); return; }\n      if (d.item) applyItem(d.item);\n      else if (d.patch) store.patch(d.patch);\n      else if (d && typeof d==='object') store.patch(d);\n    }, { retained: true });\n  }\n\n  function onStoreChange(){\n    if (!autoSave || !currentId) return;\n    if (applying>0) return; // ignore remote updates\n    clearTimeout(t);\n    t = setTimeout(async ()=>{\n      try {\n        saving = true;\n        const item = store.snapshot();\n        await pc.request(`${resource}.item.save`, { item });\n      } catch {} finally { saving = false; }\n    }, Math.max(0, debounceMs|0));\n  }\n\n  // Initial wiring\n  const unsubStore = store.subscribe(onStoreChange);\n  if (followSelect) offSel = pc.subscribe(`${resource}.item.select`, async (m)=>{\n    const sel = m?.data?.id; if (!sel) return;\n    currentId = sel; subscribeLive();\n    try { const { data } = await pc.request(`${resource}.item.get`, { id: sel }); if (data?.item) applyItem(data.item); } catch {}\n  });\n  if (currentId) { subscribeLive(); (async()=>{ try { const { data } = await pc.request(`${resource}.item.get`, { id: currentId }); if (data?.item) applyItem(data.item); } catch {} })(); }\n\n  return ()=>{ try{ offLive&&offLive(); }catch{} try{ offSel&&offSel(); }catch{} try{ unsubStore&&unsubStore(); }catch{} clearTimeout(t); };\n}\n\nexport function syncList(store, { resource='items', key='id', live=true } = {}){\n  const pc = new PanClient();\n  let items = [];\n  function render(){ store._setAll({ items }); }\n  function applyItem(d, topic){\n    // Determine id\n    let id = d?.id ?? d?.item?.[key] ?? d?.item?.id;\n    if (id==null && topic) { const parts = String(topic).split('.'); id = parts[parts.length-1]; }\n    if (id==null) return;\n    const idx = items.findIndex(x => String(x?.[key] ?? x?.id) === String(id));\n    if (d.deleted) { if (idx>=0) items.splice(idx,1); return; }\n    if (d.item && typeof d.item==='object') { if (idx>=0) items[idx]=d.item; else items.push(d.item); return; }\n    const patch = d.patch || d;\n    if (patch && typeof patch==='object') { const base = idx>=0 ? items[idx] : {}; const next = Object.assign({}, base, patch); if (idx>=0) items[idx]=next; else items.push(next); }\n  }\n  const offA = pc.subscribe(`${resource}.list.state`, (m)=>{ items = m?.data?.items || []; render(); }, { retained:true });\n  const offB = live ? pc.subscribe(`${resource}.item.state.*`, (m)=>{ applyItem(m?.data||{}, m?.topic); render(); }) : null;\n  pc.publish({ topic: `${resource}.list.get`, data:{} });\n  return ()=>{ try{ offA&&offA(); }catch{} try{ offB&&offB(); }catch{} };\n}\n\nexport default { syncItem, syncList };\n\n"],
  "mappings": "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",
  "names": []
}
