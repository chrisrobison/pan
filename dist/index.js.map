{
  "version": 3,
  "sources": ["../src/index.js"],
  "sourcesContent": ["// Unified PAN entry point - includes bus + client in a single package\n// Usage:\n//   import { PanClient } from 'pan';\n//   const client = new PanClient();\n//   client.pub('app.ready', { version: '1.0' });\n\n// ============================================================================\n// PAN BUS - Minimal message bus as custom element\n// ============================================================================\n\nclass PanBus extends HTMLElement {\n  constructor() {\n    super();\n    this.subs = [];         // { pattern, el, clientId, retained?:boolean }\n    this.retained = new Map(); // topic -> last message\n    this.clients = new Map();  // clientId -> { el, caps }\n  }\n\n  connectedCallback() {\n    // capture listeners so bus observes events early in the capture phase\n    document.addEventListener('pan:publish', this.onPublish, true);\n    document.addEventListener('pan:request', this.onPublish, true);\n    document.addEventListener('pan:reply', this.onReply, true);\n    document.addEventListener('pan:subscribe', this.onSubscribe, true);\n    document.addEventListener('pan:unsubscribe', this.onUnsubscribe, true);\n    document.addEventListener('pan:hello', this.onHello, true);\n    // announce readiness\n    window.__panReady = true;\n    document.dispatchEvent(new CustomEvent('pan:sys.ready', { bubbles: true, composed: true }));\n  }\n\n  disconnectedCallback() {\n    document.removeEventListener('pan:publish', this.onPublish, true);\n    document.removeEventListener('pan:request', this.onPublish, true);\n    document.removeEventListener('pan:reply', this.onReply, true);\n    document.removeEventListener('pan:subscribe', this.onSubscribe, true);\n    document.removeEventListener('pan:unsubscribe', this.onUnsubscribe, true);\n    document.removeEventListener('pan:hello', this.onHello, true);\n  }\n\n  onHello = (e) => {\n    const d = e.detail || {};\n    if (d.id) this.clients.set(d.id, { el: this._et(e), caps: d.caps || [] });\n  };\n\n  onSubscribe = (e) => {\n    const { topics = [], options = {}, clientId } = e.detail || {};\n    const el = this._et(e);\n    for (const pattern of topics) this.subs.push({ pattern, el, clientId, retained: !!options.retained });\n    // deliver retained snapshots if requested\n    if (options.retained) {\n      for (const [topic, msg] of this.retained) {\n        if (topics.some((p) => PanBus.matches(topic, p))) this._deliver(el, msg);\n      }\n    }\n  };\n\n  onUnsubscribe = (e) => {\n    const { topics = [], clientId } = e.detail || {};\n    const el = this._et(e);\n    this.subs = this.subs.filter((s) => {\n      const sameClient = clientId ? s.clientId === clientId : s.el === el;\n      return !(sameClient && topics.includes(s.pattern));\n    });\n  };\n\n  onPublish = (e) => {\n    const base = e.detail || {};\n    const msg = Object.assign({ ts: Date.now(), id: crypto.randomUUID() }, base);\n    if (msg.retain) this.retained.set(msg.topic, msg);\n    for (const s of this.subs) if (PanBus.matches(msg.topic, s.pattern)) this._deliver(s.el, msg);\n  };\n\n  onReply = (e) => {\n    const msg = e.detail || {};\n    for (const s of this.subs) if (PanBus.matches(msg.topic, s.pattern)) this._deliver(s.el, msg);\n  };\n\n  _deliver(target, msg) {\n    try { target.dispatchEvent(new CustomEvent('pan:deliver', { detail: msg })); } catch (_) { /* ignore */ }\n  }\n\n  _et(e) { return (typeof e.composedPath === 'function' ? e.composedPath()[0] : (e.target || document)); }\n\n  static matches(topic, pattern) {\n    if (pattern === '*' || topic === pattern) return true;\n    if (pattern && pattern.includes('*')) {\n      const esc = (s) => s.replace(/[|\\\\{}()\\[\\]^$+?.]/g, '\\\\$&').replace(/\\*/g, '[^.]+');\n      const rx = new RegExp(`^${esc(pattern)}$`);\n      return rx.test(topic);\n    }\n    return false;\n  }\n}\n\n// Auto-register the pan-bus custom element\nif (typeof customElements !== 'undefined' && !customElements.get('pan-bus')) {\n  customElements.define('pan-bus', PanBus);\n}\n\n// ============================================================================\n// PAN CLIENT - JavaScript API for publish/subscribe\n// ============================================================================\n\nclass PanClient {\n  /**\n   * @param {HTMLElement|Document} host\n   * @param {string} busSelector css selector for the bus element (unused, for compatibility)\n   */\n  constructor(host = document, busSelector = 'pan-bus') {\n    this.host = host;\n    this.bus = /** @type {HTMLElement|null} */(document.querySelector(busSelector));\n    if (!this.bus) {\n      // Do not throw to allow late bus; ready() will resolve on pan:sys.ready\n    }\n    const tag = host instanceof HTMLElement ? host.tagName.toLowerCase() + (host.id ? ('#' + host.id) : '') : 'doc';\n    this.clientId = `${tag}#${Math.random().toString(36).slice(2, 8)}`;\n    this._ready = new Promise((res) => {\n      const onReady = () => { document.removeEventListener('pan:sys.ready', onReady, true); res(); };\n      if (globalThis.window && window.__panReady) return res();\n      document.addEventListener('pan:sys.ready', onReady, true);\n    }).then(() => {\n      this._dispatch('pan:hello', { id: this.clientId, caps: ['client'] });\n    });\n  }\n\n  ready() { return this._ready; }\n\n  /** @param {string} type @param {any} detail */\n  _dispatch(type, detail) {\n    this.host.dispatchEvent(new CustomEvent(type, { detail, bubbles: true, composed: true }));\n  }\n\n  /**\n   * Publish a message\n   * @param {{topic:string,data:any,id?:string,ts?:number,replyTo?:string,correlationId?:string,retain?:boolean,headers?:Record<string,string>}} msg\n   */\n  publish(msg) { this._dispatch('pan:publish', msg); }\n\n  /**\n   * Convenience alias for publish\n   * @param {string} topic\n   * @param {any} data\n   * @param {{retain?:boolean}=} options\n   */\n  pub(topic, data, options = {}) {\n    this.publish({ topic, data, ...options });\n  }\n\n  /**\n   * Subscribe to one or more topics. Returns an unsubscribe function.\n   * @param {string|string[]} topics\n   * @param {(m:any)=>void} handler\n   * @param {{ retained?: boolean, signal?: AbortSignal }=} opts\n   */\n  subscribe(topics, handler, opts = {}) {\n    topics = Array.isArray(topics) ? topics : [topics];\n    const onDeliver = (ev) => {\n      const m = ev.detail; if (!m || !m.topic) return;\n      if (topics.some((t) => PanClient.matches(m.topic, t))) handler(m);\n    };\n    this.host.addEventListener('pan:deliver', onDeliver);\n    this._dispatch('pan:subscribe', { clientId: this.clientId, topics, options: { retained: !!opts.retained } });\n    const off = () => {\n      this.host.removeEventListener('pan:deliver', onDeliver);\n      this._dispatch('pan:unsubscribe', { clientId: this.clientId, topics });\n    };\n    if (opts.signal) {\n      const onAbort = () => { off(); opts.signal?.removeEventListener('abort', onAbort); };\n      opts.signal.addEventListener('abort', onAbort, { once: true });\n    }\n    return off;\n  }\n\n  /**\n   * Convenience alias for subscribe\n   */\n  sub(topics, handler, opts) {\n    return this.subscribe(topics, handler, opts);\n  }\n\n  /**\n   * Request/Reply convenience helper. Resolves with the reply message.\n   * @param {string} topic\n   * @param {any} data\n   * @param {{ timeoutMs?: number }=} options\n   */\n  request(topic, data, { timeoutMs = 5000 } = {}) {\n    const correlationId = crypto.randomUUID();\n    const replyTo = `pan:$reply:${this.clientId}:${correlationId}`;\n    return new Promise((resolve, reject) => {\n      const off = this.subscribe(replyTo, (m) => {\n        clearTimeout(timer);\n        off();\n        resolve(m);\n      });\n      const timer = setTimeout(() => { off(); reject(new Error('PAN request timeout')); }, timeoutMs);\n      this.publish({ topic, data, replyTo, correlationId });\n    });\n  }\n\n  /** topic pattern matcher: supports '*', segment wildcards (foo.*, *.bar, foo.*.baz) */\n  static matches(topic, pattern) {\n    if (pattern === '*' || topic === pattern) return true;\n    if (pattern && pattern.includes('*')) {\n      const esc = (s) => s.replace(/[|\\\\{}()\\[\\]^$+?.]/g, '\\\\$&').replace(/\\*/g, '[^.]+');\n      const rx = new RegExp(`^${esc(pattern)}$`);\n      return rx.test(topic);\n    }\n    return false;\n  }\n}\n\n// ============================================================================\n// HELPER FUNCTIONS\n// ============================================================================\n\n/**\n * Ensure a pan-bus element exists in the document.\n * Creates one if it doesn't exist. Returns the bus element.\n */\nexport function ensureBus() {\n  let bus = document.querySelector('pan-bus');\n  if (!bus) {\n    bus = document.createElement('pan-bus');\n    document.body.prepend(bus);\n  }\n  return bus;\n}\n\n/**\n * Create a default PanClient instance.\n * Automatically ensures bus exists.\n */\nexport function createClient(host = document) {\n  ensureBus();\n  return new PanClient(host);\n}\n\n// ============================================================================\n// EXPORTS\n// ============================================================================\n\nexport { PanBus, PanClient };\nexport default PanClient;\n"],
  "mappings": ";AAUA,IAAM,SAAN,MAAM,gBAAe,YAAY;AAAA,EAC/B,cAAc;AACZ,UAAM;AACN,SAAK,OAAO,CAAC;AACb,SAAK,WAAW,oBAAI,IAAI;AACxB,SAAK,UAAU,oBAAI,IAAI;AAAA,EACzB;AAAA,EAEA,oBAAoB;AAElB,aAAS,iBAAiB,eAAe,KAAK,WAAW,IAAI;AAC7D,aAAS,iBAAiB,eAAe,KAAK,WAAW,IAAI;AAC7D,aAAS,iBAAiB,aAAa,KAAK,SAAS,IAAI;AACzD,aAAS,iBAAiB,iBAAiB,KAAK,aAAa,IAAI;AACjE,aAAS,iBAAiB,mBAAmB,KAAK,eAAe,IAAI;AACrE,aAAS,iBAAiB,aAAa,KAAK,SAAS,IAAI;AAEzD,WAAO,aAAa;AACpB,aAAS,cAAc,IAAI,YAAY,iBAAiB,EAAE,SAAS,MAAM,UAAU,KAAK,CAAC,CAAC;AAAA,EAC5F;AAAA,EAEA,uBAAuB;AACrB,aAAS,oBAAoB,eAAe,KAAK,WAAW,IAAI;AAChE,aAAS,oBAAoB,eAAe,KAAK,WAAW,IAAI;AAChE,aAAS,oBAAoB,aAAa,KAAK,SAAS,IAAI;AAC5D,aAAS,oBAAoB,iBAAiB,KAAK,aAAa,IAAI;AACpE,aAAS,oBAAoB,mBAAmB,KAAK,eAAe,IAAI;AACxE,aAAS,oBAAoB,aAAa,KAAK,SAAS,IAAI;AAAA,EAC9D;AAAA,EAEA,UAAU,CAAC,MAAM;AACf,UAAM,IAAI,EAAE,UAAU,CAAC;AACvB,QAAI,EAAE,GAAI,MAAK,QAAQ,IAAI,EAAE,IAAI,EAAE,IAAI,KAAK,IAAI,CAAC,GAAG,MAAM,EAAE,QAAQ,CAAC,EAAE,CAAC;AAAA,EAC1E;AAAA,EAEA,cAAc,CAAC,MAAM;AACnB,UAAM,EAAE,SAAS,CAAC,GAAG,UAAU,CAAC,GAAG,SAAS,IAAI,EAAE,UAAU,CAAC;AAC7D,UAAM,KAAK,KAAK,IAAI,CAAC;AACrB,eAAW,WAAW,OAAQ,MAAK,KAAK,KAAK,EAAE,SAAS,IAAI,UAAU,UAAU,CAAC,CAAC,QAAQ,SAAS,CAAC;AAEpG,QAAI,QAAQ,UAAU;AACpB,iBAAW,CAAC,OAAO,GAAG,KAAK,KAAK,UAAU;AACxC,YAAI,OAAO,KAAK,CAAC,MAAM,QAAO,QAAQ,OAAO,CAAC,CAAC,EAAG,MAAK,SAAS,IAAI,GAAG;AAAA,MACzE;AAAA,IACF;AAAA,EACF;AAAA,EAEA,gBAAgB,CAAC,MAAM;AACrB,UAAM,EAAE,SAAS,CAAC,GAAG,SAAS,IAAI,EAAE,UAAU,CAAC;AAC/C,UAAM,KAAK,KAAK,IAAI,CAAC;AACrB,SAAK,OAAO,KAAK,KAAK,OAAO,CAAC,MAAM;AAClC,YAAM,aAAa,WAAW,EAAE,aAAa,WAAW,EAAE,OAAO;AACjE,aAAO,EAAE,cAAc,OAAO,SAAS,EAAE,OAAO;AAAA,IAClD,CAAC;AAAA,EACH;AAAA,EAEA,YAAY,CAAC,MAAM;AACjB,UAAM,OAAO,EAAE,UAAU,CAAC;AAC1B,UAAM,MAAM,OAAO,OAAO,EAAE,IAAI,KAAK,IAAI,GAAG,IAAI,OAAO,WAAW,EAAE,GAAG,IAAI;AAC3E,QAAI,IAAI,OAAQ,MAAK,SAAS,IAAI,IAAI,OAAO,GAAG;AAChD,eAAW,KAAK,KAAK,KAAM,KAAI,QAAO,QAAQ,IAAI,OAAO,EAAE,OAAO,EAAG,MAAK,SAAS,EAAE,IAAI,GAAG;AAAA,EAC9F;AAAA,EAEA,UAAU,CAAC,MAAM;AACf,UAAM,MAAM,EAAE,UAAU,CAAC;AACzB,eAAW,KAAK,KAAK,KAAM,KAAI,QAAO,QAAQ,IAAI,OAAO,EAAE,OAAO,EAAG,MAAK,SAAS,EAAE,IAAI,GAAG;AAAA,EAC9F;AAAA,EAEA,SAAS,QAAQ,KAAK;AACpB,QAAI;AAAE,aAAO,cAAc,IAAI,YAAY,eAAe,EAAE,QAAQ,IAAI,CAAC,CAAC;AAAA,IAAG,SAAS,GAAG;AAAA,IAAe;AAAA,EAC1G;AAAA,EAEA,IAAI,GAAG;AAAE,WAAQ,OAAO,EAAE,iBAAiB,aAAa,EAAE,aAAa,EAAE,CAAC,IAAK,EAAE,UAAU;AAAA,EAAY;AAAA,EAEvG,OAAO,QAAQ,OAAO,SAAS;AAC7B,QAAI,YAAY,OAAO,UAAU,QAAS,QAAO;AACjD,QAAI,WAAW,QAAQ,SAAS,GAAG,GAAG;AACpC,YAAM,MAAM,CAAC,MAAM,EAAE,QAAQ,uBAAuB,MAAM,EAAE,QAAQ,OAAO,OAAO;AAClF,YAAM,KAAK,IAAI,OAAO,IAAI,IAAI,OAAO,CAAC,GAAG;AACzC,aAAO,GAAG,KAAK,KAAK;AAAA,IACtB;AACA,WAAO;AAAA,EACT;AACF;AAGA,IAAI,OAAO,mBAAmB,eAAe,CAAC,eAAe,IAAI,SAAS,GAAG;AAC3E,iBAAe,OAAO,WAAW,MAAM;AACzC;AAMA,IAAM,YAAN,MAAM,WAAU;AAAA;AAAA;AAAA;AAAA;AAAA,EAKd,YAAY,OAAO,UAAU,cAAc,WAAW;AACpD,SAAK,OAAO;AACZ,SAAK;AAAA,IAAsC,SAAS,cAAc,WAAW;AAC7E,QAAI,CAAC,KAAK,KAAK;AAAA,IAEf;AACA,UAAM,MAAM,gBAAgB,cAAc,KAAK,QAAQ,YAAY,KAAK,KAAK,KAAM,MAAM,KAAK,KAAM,MAAM;AAC1G,SAAK,WAAW,GAAG,GAAG,IAAI,KAAK,OAAO,EAAE,SAAS,EAAE,EAAE,MAAM,GAAG,CAAC,CAAC;AAChE,SAAK,SAAS,IAAI,QAAQ,CAAC,QAAQ;AACjC,YAAM,UAAU,MAAM;AAAE,iBAAS,oBAAoB,iBAAiB,SAAS,IAAI;AAAG,YAAI;AAAA,MAAG;AAC7F,UAAI,WAAW,UAAU,OAAO,WAAY,QAAO,IAAI;AACvD,eAAS,iBAAiB,iBAAiB,SAAS,IAAI;AAAA,IAC1D,CAAC,EAAE,KAAK,MAAM;AACZ,WAAK,UAAU,aAAa,EAAE,IAAI,KAAK,UAAU,MAAM,CAAC,QAAQ,EAAE,CAAC;AAAA,IACrE,CAAC;AAAA,EACH;AAAA,EAEA,QAAQ;AAAE,WAAO,KAAK;AAAA,EAAQ;AAAA;AAAA,EAG9B,UAAU,MAAM,QAAQ;AACtB,SAAK,KAAK,cAAc,IAAI,YAAY,MAAM,EAAE,QAAQ,SAAS,MAAM,UAAU,KAAK,CAAC,CAAC;AAAA,EAC1F;AAAA;AAAA;AAAA;AAAA;AAAA,EAMA,QAAQ,KAAK;AAAE,SAAK,UAAU,eAAe,GAAG;AAAA,EAAG;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAQnD,IAAI,OAAO,MAAM,UAAU,CAAC,GAAG;AAC7B,SAAK,QAAQ,EAAE,OAAO,MAAM,GAAG,QAAQ,CAAC;AAAA,EAC1C;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAQA,UAAU,QAAQ,SAAS,OAAO,CAAC,GAAG;AACpC,aAAS,MAAM,QAAQ,MAAM,IAAI,SAAS,CAAC,MAAM;AACjD,UAAM,YAAY,CAAC,OAAO;AACxB,YAAM,IAAI,GAAG;AAAQ,UAAI,CAAC,KAAK,CAAC,EAAE,MAAO;AACzC,UAAI,OAAO,KAAK,CAAC,MAAM,WAAU,QAAQ,EAAE,OAAO,CAAC,CAAC,EAAG,SAAQ,CAAC;AAAA,IAClE;AACA,SAAK,KAAK,iBAAiB,eAAe,SAAS;AACnD,SAAK,UAAU,iBAAiB,EAAE,UAAU,KAAK,UAAU,QAAQ,SAAS,EAAE,UAAU,CAAC,CAAC,KAAK,SAAS,EAAE,CAAC;AAC3G,UAAM,MAAM,MAAM;AAChB,WAAK,KAAK,oBAAoB,eAAe,SAAS;AACtD,WAAK,UAAU,mBAAmB,EAAE,UAAU,KAAK,UAAU,OAAO,CAAC;AAAA,IACvE;AACA,QAAI,KAAK,QAAQ;AACf,YAAM,UAAU,MAAM;AAAE,YAAI;AAAG,aAAK,QAAQ,oBAAoB,SAAS,OAAO;AAAA,MAAG;AACnF,WAAK,OAAO,iBAAiB,SAAS,SAAS,EAAE,MAAM,KAAK,CAAC;AAAA,IAC/D;AACA,WAAO;AAAA,EACT;AAAA;AAAA;AAAA;AAAA,EAKA,IAAI,QAAQ,SAAS,MAAM;AACzB,WAAO,KAAK,UAAU,QAAQ,SAAS,IAAI;AAAA,EAC7C;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAQA,QAAQ,OAAO,MAAM,EAAE,YAAY,IAAK,IAAI,CAAC,GAAG;AAC9C,UAAM,gBAAgB,OAAO,WAAW;AACxC,UAAM,UAAU,cAAc,KAAK,QAAQ,IAAI,aAAa;AAC5D,WAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACtC,YAAM,MAAM,KAAK,UAAU,SAAS,CAAC,MAAM;AACzC,qBAAa,KAAK;AAClB,YAAI;AACJ,gBAAQ,CAAC;AAAA,MACX,CAAC;AACD,YAAM,QAAQ,WAAW,MAAM;AAAE,YAAI;AAAG,eAAO,IAAI,MAAM,qBAAqB,CAAC;AAAA,MAAG,GAAG,SAAS;AAC9F,WAAK,QAAQ,EAAE,OAAO,MAAM,SAAS,cAAc,CAAC;AAAA,IACtD,CAAC;AAAA,EACH;AAAA;AAAA,EAGA,OAAO,QAAQ,OAAO,SAAS;AAC7B,QAAI,YAAY,OAAO,UAAU,QAAS,QAAO;AACjD,QAAI,WAAW,QAAQ,SAAS,GAAG,GAAG;AACpC,YAAM,MAAM,CAAC,MAAM,EAAE,QAAQ,uBAAuB,MAAM,EAAE,QAAQ,OAAO,OAAO;AAClF,YAAM,KAAK,IAAI,OAAO,IAAI,IAAI,OAAO,CAAC,GAAG;AACzC,aAAO,GAAG,KAAK,KAAK;AAAA,IACtB;AACA,WAAO;AAAA,EACT;AACF;AAUO,SAAS,YAAY;AAC1B,MAAI,MAAM,SAAS,cAAc,SAAS;AAC1C,MAAI,CAAC,KAAK;AACR,UAAM,SAAS,cAAc,SAAS;AACtC,aAAS,KAAK,QAAQ,GAAG;AAAA,EAC3B;AACA,SAAO;AACT;AAMO,SAAS,aAAa,OAAO,UAAU;AAC5C,YAAU;AACV,SAAO,IAAI,UAAU,IAAI;AAC3B;AAOA,IAAO,gBAAQ;",
  "names": []
}
