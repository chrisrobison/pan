{
  "version": 3,
  "sources": ["../../src/core/pan-validation.mjs"],
  "sourcesContent": ["/**\n * @fileoverview PAN Validation Utilities\n *\n * Shared validation functions for message and topic validation\n * Used by both PAN Bus and PAN Client for consistency\n */\n\n/**\n * Check if data is JSON-serializable\n * @param {*} data - Data to check\n * @returns {boolean} True if serializable\n */\nexport function isSerializable(data) {\n  try {\n    JSON.stringify(data);\n    return true;\n  } catch (e) {\n    return false;\n  }\n}\n\n/**\n * Get detailed reason why data is not serializable\n * @param {*} data - Data to check\n * @returns {{valid: boolean, error?: string}} Validation result\n */\nexport function checkSerializable(data) {\n  // Undefined is okay\n  if (data === undefined) {\n    return { valid: true };\n  }\n\n  // Check for common non-serializable types\n  if (typeof data === 'function') {\n    return { valid: false, error: 'Functions cannot be serialized' };\n  }\n\n  if (data instanceof Node || data instanceof Element) {\n    return { valid: false, error: 'DOM nodes cannot be serialized' };\n  }\n\n  if (data instanceof Window) {\n    return { valid: false, error: 'Window objects cannot be serialized' };\n  }\n\n  // Try serialization\n  try {\n    JSON.stringify(data);\n    return { valid: true };\n  } catch (e) {\n    if (e.message.includes('circular')) {\n      return { valid: false, error: 'Circular references are not allowed' };\n    }\n    if (e.message.includes('BigInt')) {\n      return { valid: false, error: 'BigInt values are not JSON-serializable (convert to string first)' };\n    }\n    return { valid: false, error: `Serialization error: ${e.message}` };\n  }\n}\n\n/**\n * Estimate size of object in bytes\n * @param {*} obj - Object to measure\n * @returns {number} Approximate size in bytes\n */\nexport function estimateSize(obj) {\n  try {\n    const json = JSON.stringify(obj);\n    return new Blob([json]).size;\n  } catch (e) {\n    return 0;\n  }\n}\n\n/**\n * Validate topic string\n * @param {string} topic - Topic to validate\n * @returns {{valid: boolean, error?: string}} Validation result\n */\nexport function validateTopic(topic) {\n  if (!topic || typeof topic !== 'string') {\n    return { valid: false, error: 'Topic must be a non-empty string' };\n  }\n\n  if (topic.length > 256) {\n    return { valid: false, error: 'Topic must be less than 256 characters' };\n  }\n\n  // Check for invalid characters\n  if (!/^[a-z0-9:.*_-]+$/i.test(topic)) {\n    return {\n      valid: false,\n      error: 'Topic can only contain letters, numbers, dots, colons, hyphens, underscores, and asterisks'\n    };\n  }\n\n  // Check for consecutive dots\n  if (topic.includes('..')) {\n    return { valid: false, error: 'Topic cannot contain consecutive dots' };\n  }\n\n  // Check for leading/trailing dots\n  if (topic.startsWith('.') || topic.endsWith('.')) {\n    return { valid: false, error: 'Topic cannot start or end with a dot' };\n  }\n\n  return { valid: true };\n}\n\n/**\n * Validate subscription pattern\n * @param {string} pattern - Pattern to validate\n * @param {Object} options - Validation options\n * @param {boolean} [options.allowGlobalWildcard=true] - Allow '*' pattern\n * @param {number} [options.maxWildcards=5] - Max wildcard segments\n * @returns {{valid: boolean, error?: string}} Validation result\n */\nexport function validatePattern(pattern, options = {}) {\n  const {\n    allowGlobalWildcard = true,\n    maxWildcards = 5\n  } = options;\n\n  // First validate as topic\n  const topicValidation = validateTopic(pattern);\n  if (!topicValidation.valid) {\n    return topicValidation;\n  }\n\n  // Check global wildcard\n  if (pattern === '*') {\n    if (!allowGlobalWildcard) {\n      return {\n        valid: false,\n        error: 'Global wildcard (*) is disabled for security reasons'\n      };\n    }\n    return { valid: true };\n  }\n\n  // Count wildcards\n  const wildcardCount = (pattern.match(/\\*/g) || []).length;\n  if (wildcardCount > maxWildcards) {\n    return {\n      valid: false,\n      error: `Too many wildcards (${wildcardCount}), maximum is ${maxWildcards}`\n    };\n  }\n\n  // Check for wildcard positioning\n  const segments = pattern.split('.');\n  for (const segment of segments) {\n    if (segment.includes('*') && segment !== '*') {\n      return {\n        valid: false,\n        error: 'Wildcards must be a complete segment (use \"users.*\" not \"users.u*\")'\n      };\n    }\n  }\n\n  return { valid: true };\n}\n\n/**\n * Validate complete PAN message\n * @param {Object} msg - Message to validate\n * @param {Object} limits - Size limits\n * @param {number} [limits.maxMessageSize=1048576] - Max total message size\n * @param {number} [limits.maxPayloadSize=524288] - Max data payload size\n * @returns {{valid: boolean, error?: string}} Validation result\n */\nexport function validateMessage(msg, limits = {}) {\n  const {\n    maxMessageSize = 1048576,\n    maxPayloadSize = 524288\n  } = limits;\n\n  // Check topic\n  const topicValidation = validateTopic(msg.topic);\n  if (!topicValidation.valid) {\n    return topicValidation;\n  }\n\n  // Check data serialization\n  const dataValidation = checkSerializable(msg.data);\n  if (!dataValidation.valid) {\n    return { valid: false, error: `Data validation failed: ${dataValidation.error}` };\n  }\n\n  // Check message size\n  const msgSize = estimateSize(msg);\n  if (msgSize > maxMessageSize) {\n    return {\n      valid: false,\n      error: `Message size (${msgSize} bytes) exceeds limit (${maxMessageSize} bytes)`\n    };\n  }\n\n  // Check payload size\n  const dataSize = estimateSize(msg.data);\n  if (dataSize > maxPayloadSize) {\n    return {\n      valid: false,\n      error: `Payload size (${dataSize} bytes) exceeds limit (${maxPayloadSize} bytes)`\n    };\n  }\n\n  // Validate optional fields\n  if (msg.id !== undefined && typeof msg.id !== 'string') {\n    return { valid: false, error: 'Message id must be a string' };\n  }\n\n  if (msg.ts !== undefined && typeof msg.ts !== 'number') {\n    return { valid: false, error: 'Message timestamp must be a number' };\n  }\n\n  if (msg.retain !== undefined && typeof msg.retain !== 'boolean') {\n    return { valid: false, error: 'Message retain must be a boolean' };\n  }\n\n  if (msg.replyTo !== undefined) {\n    const replyToValidation = validateTopic(msg.replyTo);\n    if (!replyToValidation.valid) {\n      return { valid: false, error: `Invalid replyTo: ${replyToValidation.error}` };\n    }\n  }\n\n  if (msg.correlationId !== undefined && typeof msg.correlationId !== 'string') {\n    return { valid: false, error: 'Message correlationId must be a string' };\n  }\n\n  if (msg.headers !== undefined) {\n    if (typeof msg.headers !== 'object' || Array.isArray(msg.headers)) {\n      return { valid: false, error: 'Message headers must be an object' };\n    }\n    // Validate headers are all strings\n    for (const [key, value] of Object.entries(msg.headers)) {\n      if (typeof value !== 'string') {\n        return { valid: false, error: `Header \"${key}\" must be a string value` };\n      }\n    }\n  }\n\n  return { valid: true };\n}\n\n/**\n * Check if element is still alive in DOM\n * @param {Element} el - Element to check\n * @returns {boolean} True if element is in DOM\n */\nexport function isElementAlive(el) {\n  if (!el) return false;\n  if (!el.isConnected) return false;\n  return document.contains(el) || document.body.contains(el);\n}\n\n/**\n * Sanitize error message for safe display\n * @param {*} error - Error to sanitize\n * @returns {string} Safe error message\n */\nexport function sanitizeError(error) {\n  if (!error) return 'Unknown error';\n\n  if (typeof error === 'string') {\n    // Remove potential sensitive data patterns\n    return error.replace(/\\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Z|a-z]{2,}\\b/g, '[email]')\n                .replace(/\\b\\d{4}[-\\s]?\\d{4}[-\\s]?\\d{4}[-\\s]?\\d{4}\\b/g, '[card]')\n                .replace(/\\b\\d{3}-\\d{2}-\\d{4}\\b/g, '[ssn]');\n  }\n\n  if (error instanceof Error) {\n    return sanitizeError(error.message);\n  }\n\n  try {\n    return sanitizeError(String(error));\n  } catch (e) {\n    return 'Error cannot be displayed';\n  }\n}\n\nexport default {\n  isSerializable,\n  checkSerializable,\n  estimateSize,\n  validateTopic,\n  validatePattern,\n  validateMessage,\n  isElementAlive,\n  sanitizeError\n};\n"],
  "mappings": "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",
  "names": []
}
