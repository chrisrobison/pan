{
  "version": 3,
  "sources": ["../../src/core/pan-client.mjs"],
  "sourcesContent": ["/**\n * @fileoverview PAN Client - Simple API for interacting with the PAN bus\n *\n * PanClient provides a clean, promise-based API for publish/subscribe messaging\n * and request/reply patterns. It handles the low-level CustomEvent details and\n * provides convenient methods for common operations.\n *\n * @example\n * // Basic usage\n * import { PanClient } from './pan-client.mjs';\n *\n * const client = new PanClient();\n * await client.ready();\n *\n * // Publish a message\n * client.publish({\n *   topic: 'users.list.state',\n *   data: { users: [...] },\n *   retain: true\n * });\n *\n * // Subscribe to messages\n * const unsubscribe = client.subscribe('users.*', (msg) => {\n *   console.log('Received:', msg.topic, msg.data);\n * });\n *\n * // Request/reply\n * const response = await client.request('users.get', { id: 123 });\n * console.log('User:', response.data);\n */\n\n/**\n * @typedef {Object} PanMessage\n * @property {string} topic - Topic name (e.g., \"users.list.state\")\n * @property {*} data - Message payload (any JSON-serializable value)\n * @property {string} [id] - Unique message ID (UUID, auto-generated by bus)\n * @property {number} [ts] - Timestamp in milliseconds (auto-generated by bus)\n * @property {boolean} [retain] - If true, message is retained by bus for new subscribers\n * @property {string} [replyTo] - Topic to send reply to (for request/reply pattern)\n * @property {string} [correlationId] - Correlation ID for matching requests and replies\n * @property {Object<string, string>} [headers] - Optional metadata headers\n */\n\n/**\n * @typedef {Object} SubscribeOptions\n * @property {boolean} [retained] - If true, receive retained messages immediately\n * @property {AbortSignal} [signal] - AbortSignal to automatically unsubscribe\n */\n\n/**\n * @typedef {Object} RequestOptions\n * @property {number} [timeoutMs=5000] - Request timeout in milliseconds\n */\n\n/**\n * @callback MessageHandler\n * @param {PanMessage} message - Received message\n * @returns {void}\n */\n\n/**\n * @callback UnsubscribeFunction\n * @returns {void}\n */\n\n/**\n * PAN Client - Simplified API for PAN bus interaction\n *\n * Provides a clean interface for:\n * - Publishing messages\n * - Subscribing to topics (with wildcard support)\n * - Request/reply pattern with automatic correlation\n * - Retained message support\n * - Automatic cleanup with AbortSignal\n *\n * @class\n * @example\n * // Create client for the document\n * const client = new PanClient();\n *\n * // Or create client for a specific element\n * const myElement = document.querySelector('#my-component');\n * const client = new PanClient(myElement);\n */\nexport class PanClient {\n  /**\n   * Creates a new PAN client\n   *\n   * @param {HTMLElement|Document} [host=document] - Element to dispatch/receive events from\n   * @param {string} [busSelector='pan-bus'] - CSS selector for bus element (for compatibility)\n   *\n   * @example\n   * // Default: use document\n   * const client = new PanClient();\n   *\n   * // Use custom element\n   * const myComponent = document.querySelector('my-component');\n   * const client = new PanClient(myComponent);\n   */\n  constructor(host = document, busSelector = 'pan-bus') {\n    /**\n     * Host element for event dispatch/receive\n     * @type {HTMLElement|Document}\n     * @private\n     */\n    this.host = host;\n\n    /**\n     * Reference to pan-bus element\n     * @type {HTMLElement|null}\n     * @private\n     */\n    this.bus = /** @type {HTMLElement|null} */(document.querySelector(busSelector));\n\n    // Generate unique client ID\n    const tag = host instanceof HTMLElement\n      ? host.tagName.toLowerCase() + (host.id ? ('#' + host.id) : '')\n      : 'doc';\n\n    /**\n     * Unique client identifier\n     * @type {string}\n     * @private\n     */\n    this.clientId = `${tag}#${crypto.randomUUID()}`;\n\n    /**\n     * Promise that resolves when PAN bus is ready\n     * @type {Promise<void>}\n     * @private\n     */\n    this._ready = new Promise((res) => {\n      const onReady = () => {\n        document.removeEventListener('pan:sys.ready', onReady, true);\n        res();\n      };\n\n      // Check if already ready\n      if (globalThis.window && window.__panReady) return res();\n\n      // Wait for ready event\n      document.addEventListener('pan:sys.ready', onReady, true);\n    }).then(() => {\n      // Announce presence to bus\n      this._dispatch('pan:hello', { id: this.clientId, caps: ['client'] });\n    });\n  }\n\n  /**\n   * Returns a promise that resolves when the PAN bus is ready\n   * Safe to use before bus exists - will wait for pan:sys.ready event\n   *\n   * @returns {Promise<void>} Resolves when bus is ready\n   *\n   * @example\n   * const client = new PanClient();\n   * await client.ready();\n   * client.publish({ topic: 'app.started', data: {} });\n   */\n  ready() {\n    return this._ready;\n  }\n\n  /**\n   * Dispatches a CustomEvent on the host element\n   * Events bubble and are composed to cross shadow DOM\n   *\n   * @param {string} type - Event type (e.g., 'pan:publish')\n   * @param {*} detail - Event detail payload\n   * @private\n   */\n  _dispatch(type, detail) {\n    this.host.dispatchEvent(\n      new CustomEvent(type, { detail, bubbles: true, composed: true })\n    );\n  }\n\n  /**\n   * Publishes a message to the PAN bus\n   * Message will be delivered to all matching subscribers\n   *\n   * @param {PanMessage} msg - Message to publish\n   * @param {string} msg.topic - Topic name (required)\n   * @param {*} msg.data - Message payload (required)\n   * @param {boolean} [msg.retain] - Retain message for late subscribers\n   * @param {string} [msg.replyTo] - Topic for replies\n   * @param {string} [msg.correlationId] - Correlation ID for request/reply\n   *\n   * @example\n   * // Simple publish\n   * client.publish({\n   *   topic: 'user.updated',\n   *   data: { id: 123, name: 'Alice' }\n   * });\n   *\n   * // Retained message (last value cached)\n   * client.publish({\n   *   topic: 'users.list.state',\n   *   data: { users: [...] },\n   *   retain: true\n   * });\n   */\n  publish(msg) {\n    this._dispatch('pan:publish', msg);\n  }\n\n  /**\n   * Subscribes to one or more topic patterns\n   * Returns an unsubscribe function to stop receiving messages\n   *\n   * @param {string|string[]} topics - Topic pattern(s) to subscribe to\n   * @param {MessageHandler} handler - Function to handle received messages\n   * @param {SubscribeOptions} [opts] - Subscription options\n   * @param {boolean} [opts.retained] - Receive retained messages immediately\n   * @param {AbortSignal} [opts.signal] - AbortSignal for automatic cleanup\n   * @returns {UnsubscribeFunction} Function to unsubscribe\n   *\n   * @example\n   * // Subscribe to single topic\n   * const unsub = client.subscribe('users.updated', (msg) => {\n   *   console.log('User updated:', msg.data);\n   * });\n   *\n   * // Subscribe to multiple topics with wildcard\n   * client.subscribe(['users.*', 'posts.*'], (msg) => {\n   *   console.log('Received:', msg.topic, msg.data);\n   * });\n   *\n   * // Get retained messages immediately\n   * client.subscribe('app.state', (msg) => {\n   *   console.log('Current state:', msg.data);\n   * }, { retained: true });\n   *\n   * // Automatic cleanup with AbortController\n   * const controller = new AbortController();\n   * client.subscribe('events.*', handler, { signal: controller.signal });\n   * // Later: controller.abort(); // Unsubscribes automatically\n   */\n  subscribe(topics, handler, opts = {}) {\n    // Normalize to array\n    topics = Array.isArray(topics) ? topics : [topics];\n\n    // Create delivery handler\n    const onDeliver = (ev) => {\n      const m = ev.detail;\n      if (!m || !m.topic) return;\n\n      // Check if message matches any of our topic patterns\n      if (topics.some((t) => PanClient.matches(m.topic, t))) {\n        handler(m);\n      }\n    };\n\n    // Listen for deliveries\n    this.host.addEventListener('pan:deliver', onDeliver);\n\n    // Subscribe on bus\n    this._dispatch('pan:subscribe', {\n      clientId: this.clientId,\n      topics,\n      options: { retained: !!opts.retained }\n    });\n\n    // Create unsubscribe function\n    const off = () => {\n      this.host.removeEventListener('pan:deliver', onDeliver);\n      this._dispatch('pan:unsubscribe', { clientId: this.clientId, topics });\n    };\n\n    // Handle AbortSignal if provided\n    if (opts.signal) {\n      const onAbort = () => {\n        off();\n        opts.signal?.removeEventListener('abort', onAbort);\n      };\n      opts.signal.addEventListener('abort', onAbort, { once: true });\n    }\n\n    return off;\n  }\n\n  /**\n   * Sends a request and waits for a reply\n   * Implements request/reply pattern with automatic correlation and timeout\n   *\n   * @param {string} topic - Request topic\n   * @param {*} data - Request payload\n   * @param {RequestOptions} [options] - Request options\n   * @param {number} [options.timeoutMs=5000] - Timeout in milliseconds\n   * @returns {Promise<PanMessage>} Promise that resolves with reply message\n   * @throws {Error} If request times out\n   *\n   * @example\n   * // Simple request\n   * try {\n   *   const response = await client.request('users.get', { id: 123 });\n   *   console.log('User:', response.data);\n   * } catch (err) {\n   *   console.error('Request failed:', err);\n   * }\n   *\n   * // Custom timeout\n   * const response = await client.request('slow.operation', { ... }, {\n   *   timeoutMs: 10000  // 10 second timeout\n   * });\n   */\n  request(topic, data, { timeoutMs = 5000 } = {}) {\n    // Generate unique correlation ID\n    const correlationId = crypto.randomUUID();\n\n    // Create unique reply topic for this request\n    const replyTo = `pan:$reply:${this.clientId}:${correlationId}`;\n\n    return new Promise((resolve, reject) => {\n      // Subscribe to reply topic\n      const off = this.subscribe(replyTo, (m) => {\n        clearTimeout(timer);\n        off();\n        resolve(m);\n      });\n\n      // Setup timeout\n      const timer = setTimeout(() => {\n        off();\n        reject(new Error('PAN request timeout'));\n      }, timeoutMs);\n\n      // Publish request\n      this.publish({ topic, data, replyTo, correlationId });\n    });\n  }\n\n  /**\n   * Checks if a topic matches a pattern\n   * Supports exact match, global wildcard (*), and segment wildcards (users.*)\n   *\n   * @param {string} topic - Topic to test (e.g., \"users.list.state\")\n   * @param {string} pattern - Pattern to match (e.g., \"users.*\" or \"*\")\n   * @returns {boolean} True if topic matches pattern\n   * @static\n   *\n   * @example\n   * PanClient.matches('users.list.state', 'users.*')  // true\n   * PanClient.matches('users.list.state', 'users.list.state')  // true\n   * PanClient.matches('users.list.state', '*')  // true\n   * PanClient.matches('users.list.state', 'posts.*')  // false\n   * PanClient.matches('users.item.123', 'users.item.*')  // true\n   */\n  static matches(topic, pattern) {\n    // Exact match or global wildcard\n    if (pattern === '*' || topic === pattern) return true;\n\n    // Pattern contains wildcards\n    if (pattern && pattern.includes('*')) {\n      // Escape regex special chars, replace * with segment matcher\n      const esc = (s) => s\n        .replace(/[|\\\\{}()\\[\\]^$+?.]/g, '\\\\$&')\n        .replace(/\\*/g, '[^.]+');\n\n      const rx = new RegExp(`^${esc(pattern)}$`);\n      return rx.test(topic);\n    }\n\n    return false;\n  }\n}\n\nexport default PanClient;\n"],
  "mappings": "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",
  "names": []
}
