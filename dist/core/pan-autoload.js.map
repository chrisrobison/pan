{
  "version": 3,
  "sources": ["../../pan/core/pan-autoload.mjs"],
  "sourcesContent": ["// PAN Autoload \u2014 progressively loads Web Components on demand.\n//\n// Usage (Local):\n//   <script type=\"module\" src=\"./pan/core/pan-autoload.mjs\"></script>\n//   <!-- declare <my-widget></my-widget> anywhere -->\n//\n// Usage (CDN):\n//   <script type=\"module\">\n//     window.panAutoload = {\n//       baseUrl: 'https://unpkg.com/pan@latest/',\n//       extension: '.js'\n//     };\n//   </script>\n//   <script type=\"module\" src=\"https://unpkg.com/pan@latest/autoload.js\"></script>\n//\n// Configuration:\n//   - baseUrl: Full CDN URL (e.g., 'https://unpkg.com/pan@latest/')\n//   - componentsPath: Relative path from baseUrl (default: './')\n//   - extension: File extension (default: '.mjs' local, '.js' for npm)\n//   - rootMargin: Intersection observer margin in px (default: 600)\n//   - Override per element with `data-module=\"/path/to/file.mjs\"`\n//\n// The loader observes the document for custom element tags (names with a dash)\n// that are not yet defined. When one approaches the viewport it dynamically\n// imports the module and, if the module did not register the custom element,\n// defines it from the default export (if it is a class).\n\nconst defaults = {\n  baseUrl: null,           // Full URL base (CDN or absolute path)\n  componentsPath: './',    // Relative path from baseUrl or import.meta.url\n  extension: '.mjs',\n  rootMargin: 600,\n};\n\nconst rawGlobal =\n  typeof window !== 'undefined' && window.panAutoload && typeof window.panAutoload === 'object'\n    ? window.panAutoload\n    : {};\n\nconst config = Object.assign({}, defaults, rawGlobal);\nconfig.extension = config.extension?.startsWith('.') ? config.extension : `.${config.extension || 'mjs'}`;\nconfig.componentsPath = config.componentsPath || defaults.componentsPath;\nconfig.rootMargin = Number.isFinite(config.rootMargin) ? config.rootMargin : defaults.rootMargin;\n\n// Calculate base URL for component loading\nlet baseHref;\nif (config.baseUrl) {\n  // Use explicit baseUrl (for CDN usage)\n  const normalizedBase = config.baseUrl.endsWith('/') ? config.baseUrl : `${config.baseUrl}/`;\n  const componentsPath = config.componentsPath.startsWith('./')\n    ? config.componentsPath.slice(2)\n    : config.componentsPath;\n  try {\n    baseHref = new URL(componentsPath, normalizedBase).href;\n  } catch (_) {\n    baseHref = `${normalizedBase}${componentsPath}`;\n  }\n} else {\n  // Use relative path from import.meta.url (local development)\n  try {\n    const normalizedBase = config.componentsPath.endsWith('/') ? config.componentsPath : `${config.componentsPath}/`;\n    baseHref = new URL(normalizedBase, import.meta.url).href;\n  } catch (_) {\n    const normalizedBase = config.componentsPath.endsWith('/') ? config.componentsPath : `${config.componentsPath}/`;\n    baseHref = normalizedBase;\n  }\n}\nconfig.resolvedComponentsPath = baseHref;\n\nconst loading = new Set();\nconst observed = new WeakSet();\n\nconst hasIO = typeof window !== 'undefined' && 'IntersectionObserver' in window;\n\nconst io = hasIO\n  ? new IntersectionObserver((entries) => {\n      for (const { isIntersecting, target } of entries) {\n        if (!isIntersecting) continue;\n        io.unobserve(target);\n        maybeLoadFor(target);\n      }\n    }, { rootMargin: `${config.rootMargin}px` })\n  : null;\n\nfunction moduleFromTag(tag) {\n  try {\n    return new URL(`${tag}${config.extension}`, baseHref).href;\n  } catch (_) {\n    const normalizedBase = baseHref.endsWith('/') ? baseHref : `${baseHref}/`;\n    return `${normalizedBase}${tag}${config.extension}`;\n  }\n}\n\nfunction isCustomTag(node) {\n  if (typeof customElements === 'undefined') return false;\n  return (\n    node &&\n    node.nodeType === 1 &&\n    typeof node.tagName === 'string' &&\n    node.tagName.includes('-') &&\n    !customElements.get(node.localName)\n  );\n}\n\nfunction urlFor(el) {\n  const explicit = el.getAttribute('data-module');\n  if (explicit) return explicit;\n  return moduleFromTag(el.localName);\n}\n\nexport async function maybeLoadFor(el) {\n  if (!el || !isCustomTag(el)) return;\n  const url = urlFor(el);\n  if (!url || loading.has(url) || customElements.get(el.localName)) return;\n\n  loading.add(url);\n  try {\n    const mod = await import(url);\n    if (!customElements.get(el.localName) && mod?.default instanceof Function) {\n      customElements.define(el.localName, mod.default);\n    }\n  } catch (err) {\n    console.warn(`[pan-autoload] Failed to load ${url} for <${el.localName}>`, err);\n  } finally {\n    loading.delete(url);\n  }\n}\n\nexport function observeTree(root = document) {\n  if (!root || observed.has(root)) return;\n\n  const nodes = typeof root.querySelectorAll === 'function'\n    ? root.querySelectorAll(':not(:defined)')\n    : [];\n\n  nodes.forEach((el) => {\n    if (isCustomTag(el) && !observed.has(el)) {\n      observed.add(el);\n      if (io) io.observe(el); else maybeLoadFor(el);\n    }\n  });\n\n  if (isCustomTag(root) && !observed.has(root)) {\n    observed.add(root);\n    if (io) io.observe(root); else maybeLoadFor(root);\n  }\n}\n\nfunction setupMutationObserver() {\n  if (typeof MutationObserver === 'undefined') return;\n  const target = document.documentElement;\n  if (!target) return;\n\n  new MutationObserver((mutations) => {\n    for (const mut of mutations) {\n      if (mut.type === 'childList') {\n        mut.addedNodes.forEach((node) => observeTree(node));\n      } else if (mut.type === 'attributes' && mut.attributeName === 'data-module') {\n        if (isCustomTag(mut.target)) {\n          if (io) io.observe(mut.target); else maybeLoadFor(mut.target);\n        }\n      }\n    }\n  }).observe(target, {\n    childList: true,\n    subtree: true,\n    attributes: true,\n    attributeFilter: ['data-module'],\n  });\n}\n\nasync function ensurePanBus() {\n  // Check if pan-bus already exists in the document\n  if (document.querySelector('pan-bus')) return;\n\n  // Create and insert pan-bus element\n  const bus = document.createElement('pan-bus');\n  const target = document.body || document.documentElement;\n  if (target) {\n    target.insertBefore(bus, target.firstChild);\n  }\n\n  // Load the pan-bus component immediately\n  await maybeLoadFor(bus);\n}\n\nfunction init() {\n  if (typeof document === 'undefined' || typeof customElements === 'undefined') return;\n\n  // Ensure pan-bus is loaded first (it's the backbone)\n  ensurePanBus().then(() => {\n    observeTree(document);\n    setupMutationObserver();\n\n    if (typeof requestIdleCallback === 'function') {\n      requestIdleCallback(() => {\n        document.querySelectorAll(':not(:defined)').forEach((el) => {\n          if (isCustomTag(el)) maybeLoadFor(el);\n        });\n      });\n    } else {\n      // Fallback: eager load anything currently in view.\n      document.querySelectorAll(':not(:defined)').forEach((el) => {\n        if (isCustomTag(el)) maybeLoadFor(el);\n      });\n    }\n  });\n}\n\ninit();\n\nexport const panAutoload = {\n  config,\n  observeTree,\n  maybeLoadFor,\n};\n\nif (typeof window !== 'undefined') {\n  window.panAutoload = Object.assign(window.panAutoload || {}, panAutoload);\n}\n\nexport default panAutoload;\n"],
  "mappings": "AA2BA,MAAM,WAAW;AAAA,EACf,SAAS;AAAA;AAAA,EACT,gBAAgB;AAAA;AAAA,EAChB,WAAW;AAAA,EACX,YAAY;AACd;AAEA,MAAM,YACJ,OAAO,WAAW,eAAe,OAAO,eAAe,OAAO,OAAO,gBAAgB,WACjF,OAAO,cACP,CAAC;AAEP,MAAM,SAAS,OAAO,OAAO,CAAC,GAAG,UAAU,SAAS;AACpD,OAAO,YAAY,OAAO,WAAW,WAAW,GAAG,IAAI,OAAO,YAAY,IAAI,OAAO,aAAa,KAAK;AACvG,OAAO,iBAAiB,OAAO,kBAAkB,SAAS;AAC1D,OAAO,aAAa,OAAO,SAAS,OAAO,UAAU,IAAI,OAAO,aAAa,SAAS;AAGtF,IAAI;AACJ,IAAI,OAAO,SAAS;AAElB,QAAM,iBAAiB,OAAO,QAAQ,SAAS,GAAG,IAAI,OAAO,UAAU,GAAG,OAAO,OAAO;AACxF,QAAM,iBAAiB,OAAO,eAAe,WAAW,IAAI,IACxD,OAAO,eAAe,MAAM,CAAC,IAC7B,OAAO;AACX,MAAI;AACF,eAAW,IAAI,IAAI,gBAAgB,cAAc,EAAE;AAAA,EACrD,SAAS,GAAG;AACV,eAAW,GAAG,cAAc,GAAG,cAAc;AAAA,EAC/C;AACF,OAAO;AAEL,MAAI;AACF,UAAM,iBAAiB,OAAO,eAAe,SAAS,GAAG,IAAI,OAAO,iBAAiB,GAAG,OAAO,cAAc;AAC7G,eAAW,IAAI,IAAI,gBAAgB,YAAY,GAAG,EAAE;AAAA,EACtD,SAAS,GAAG;AACV,UAAM,iBAAiB,OAAO,eAAe,SAAS,GAAG,IAAI,OAAO,iBAAiB,GAAG,OAAO,cAAc;AAC7G,eAAW;AAAA,EACb;AACF;AACA,OAAO,yBAAyB;AAEhC,MAAM,UAAU,oBAAI,IAAI;AACxB,MAAM,WAAW,oBAAI,QAAQ;AAE7B,MAAM,QAAQ,OAAO,WAAW,eAAe,0BAA0B;AAEzE,MAAM,KAAK,QACP,IAAI,qBAAqB,CAAC,YAAY;AACpC,aAAW,EAAE,gBAAgB,OAAO,KAAK,SAAS;AAChD,QAAI,CAAC,eAAgB;AACrB,OAAG,UAAU,MAAM;AACnB,iBAAa,MAAM;AAAA,EACrB;AACF,GAAG,EAAE,YAAY,GAAG,OAAO,UAAU,KAAK,CAAC,IAC3C;AAEJ,SAAS,cAAc,KAAK;AAC1B,MAAI;AACF,WAAO,IAAI,IAAI,GAAG,GAAG,GAAG,OAAO,SAAS,IAAI,QAAQ,EAAE;AAAA,EACxD,SAAS,GAAG;AACV,UAAM,iBAAiB,SAAS,SAAS,GAAG,IAAI,WAAW,GAAG,QAAQ;AACtE,WAAO,GAAG,cAAc,GAAG,GAAG,GAAG,OAAO,SAAS;AAAA,EACnD;AACF;AAEA,SAAS,YAAY,MAAM;AACzB,MAAI,OAAO,mBAAmB,YAAa,QAAO;AAClD,SACE,QACA,KAAK,aAAa,KAClB,OAAO,KAAK,YAAY,YACxB,KAAK,QAAQ,SAAS,GAAG,KACzB,CAAC,eAAe,IAAI,KAAK,SAAS;AAEtC;AAEA,SAAS,OAAO,IAAI;AAClB,QAAM,WAAW,GAAG,aAAa,aAAa;AAC9C,MAAI,SAAU,QAAO;AACrB,SAAO,cAAc,GAAG,SAAS;AACnC;AAEA,eAAsB,aAAa,IAAI;AACrC,MAAI,CAAC,MAAM,CAAC,YAAY,EAAE,EAAG;AAC7B,QAAM,MAAM,OAAO,EAAE;AACrB,MAAI,CAAC,OAAO,QAAQ,IAAI,GAAG,KAAK,eAAe,IAAI,GAAG,SAAS,EAAG;AAElE,UAAQ,IAAI,GAAG;AACf,MAAI;AACF,UAAM,MAAM,MAAM,OAAO;AACzB,QAAI,CAAC,eAAe,IAAI,GAAG,SAAS,KAAK,KAAK,mBAAmB,UAAU;AACzE,qBAAe,OAAO,GAAG,WAAW,IAAI,OAAO;AAAA,IACjD;AAAA,EACF,SAAS,KAAK;AACZ,YAAQ,KAAK,iCAAiC,GAAG,SAAS,GAAG,SAAS,KAAK,GAAG;AAAA,EAChF,UAAE;AACA,YAAQ,OAAO,GAAG;AAAA,EACpB;AACF;AAEO,SAAS,YAAY,OAAO,UAAU;AAC3C,MAAI,CAAC,QAAQ,SAAS,IAAI,IAAI,EAAG;AAEjC,QAAM,QAAQ,OAAO,KAAK,qBAAqB,aAC3C,KAAK,iBAAiB,gBAAgB,IACtC,CAAC;AAEL,QAAM,QAAQ,CAAC,OAAO;AACpB,QAAI,YAAY,EAAE,KAAK,CAAC,SAAS,IAAI,EAAE,GAAG;AACxC,eAAS,IAAI,EAAE;AACf,UAAI,GAAI,IAAG,QAAQ,EAAE;AAAA,UAAQ,cAAa,EAAE;AAAA,IAC9C;AAAA,EACF,CAAC;AAED,MAAI,YAAY,IAAI,KAAK,CAAC,SAAS,IAAI,IAAI,GAAG;AAC5C,aAAS,IAAI,IAAI;AACjB,QAAI,GAAI,IAAG,QAAQ,IAAI;AAAA,QAAQ,cAAa,IAAI;AAAA,EAClD;AACF;AAEA,SAAS,wBAAwB;AAC/B,MAAI,OAAO,qBAAqB,YAAa;AAC7C,QAAM,SAAS,SAAS;AACxB,MAAI,CAAC,OAAQ;AAEb,MAAI,iBAAiB,CAAC,cAAc;AAClC,eAAW,OAAO,WAAW;AAC3B,UAAI,IAAI,SAAS,aAAa;AAC5B,YAAI,WAAW,QAAQ,CAAC,SAAS,YAAY,IAAI,CAAC;AAAA,MACpD,WAAW,IAAI,SAAS,gBAAgB,IAAI,kBAAkB,eAAe;AAC3E,YAAI,YAAY,IAAI,MAAM,GAAG;AAC3B,cAAI,GAAI,IAAG,QAAQ,IAAI,MAAM;AAAA,cAAQ,cAAa,IAAI,MAAM;AAAA,QAC9D;AAAA,MACF;AAAA,IACF;AAAA,EACF,CAAC,EAAE,QAAQ,QAAQ;AAAA,IACjB,WAAW;AAAA,IACX,SAAS;AAAA,IACT,YAAY;AAAA,IACZ,iBAAiB,CAAC,aAAa;AAAA,EACjC,CAAC;AACH;AAEA,eAAe,eAAe;AAE5B,MAAI,SAAS,cAAc,SAAS,EAAG;AAGvC,QAAM,MAAM,SAAS,cAAc,SAAS;AAC5C,QAAM,SAAS,SAAS,QAAQ,SAAS;AACzC,MAAI,QAAQ;AACV,WAAO,aAAa,KAAK,OAAO,UAAU;AAAA,EAC5C;AAGA,QAAM,aAAa,GAAG;AACxB;AAEA,SAAS,OAAO;AACd,MAAI,OAAO,aAAa,eAAe,OAAO,mBAAmB,YAAa;AAG9E,eAAa,EAAE,KAAK,MAAM;AACxB,gBAAY,QAAQ;AACpB,0BAAsB;AAEtB,QAAI,OAAO,wBAAwB,YAAY;AAC7C,0BAAoB,MAAM;AACxB,iBAAS,iBAAiB,gBAAgB,EAAE,QAAQ,CAAC,OAAO;AAC1D,cAAI,YAAY,EAAE,EAAG,cAAa,EAAE;AAAA,QACtC,CAAC;AAAA,MACH,CAAC;AAAA,IACH,OAAO;AAEL,eAAS,iBAAiB,gBAAgB,EAAE,QAAQ,CAAC,OAAO;AAC1D,YAAI,YAAY,EAAE,EAAG,cAAa,EAAE;AAAA,MACtC,CAAC;AAAA,IACH;AAAA,EACF,CAAC;AACH;AAEA,KAAK;AAEE,MAAM,cAAc;AAAA,EACzB;AAAA,EACA;AAAA,EACA;AACF;AAEA,IAAI,OAAO,WAAW,aAAa;AACjC,SAAO,cAAc,OAAO,OAAO,OAAO,eAAe,CAAC,GAAG,WAAW;AAC1E;AAEA,IAAO,uBAAQ;",
  "names": []
}
