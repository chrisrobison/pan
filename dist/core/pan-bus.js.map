{
  "version": 3,
  "sources": ["../../pan/core/pan-bus.mjs"],
  "sourcesContent": ["// Minimal PAN Bus as a custom element. Delivers publish/subscribe/request/reply\n// via DOM CustomEvents crossing shadow DOM.\n\nclass PanBus extends HTMLElement {\n  constructor() {\n    super();\n    this.subs = [];         // { pattern, el, clientId, retained?:boolean }\n    this.retained = new Map(); // topic -> last message\n    this.clients = new Map();  // clientId -> { el, caps }\n  }\n\n  connectedCallback() {\n    // capture listeners so bus observes events early in the capture phase\n    document.addEventListener('pan:publish', this.onPublish, true);\n    document.addEventListener('pan:request', this.onPublish, true);\n    document.addEventListener('pan:reply', this.onReply, true);\n    document.addEventListener('pan:subscribe', this.onSubscribe, true);\n    document.addEventListener('pan:unsubscribe', this.onUnsubscribe, true);\n    document.addEventListener('pan:hello', this.onHello, true);\n    // announce readiness\n    window.__panReady = true;\n    document.dispatchEvent(new CustomEvent('pan:sys.ready', { bubbles: true, composed: true }));\n  }\n\n  disconnectedCallback() {\n    document.removeEventListener('pan:publish', this.onPublish, true);\n    document.removeEventListener('pan:request', this.onPublish, true);\n    document.removeEventListener('pan:reply', this.onReply, true);\n    document.removeEventListener('pan:subscribe', this.onSubscribe, true);\n    document.removeEventListener('pan:unsubscribe', this.onUnsubscribe, true);\n    document.removeEventListener('pan:hello', this.onHello, true);\n  }\n\n  onHello = (e) => {\n    const d = e.detail || {};\n    if (d.id) this.clients.set(d.id, { el: this._et(e), caps: d.caps || [] });\n  };\n\n  onSubscribe = (e) => {\n    const { topics = [], options = {}, clientId } = e.detail || {};\n    const el = this._et(e);\n    for (const pattern of topics) this.subs.push({ pattern, el, clientId, retained: !!options.retained });\n    // deliver retained snapshots if requested\n    if (options.retained) {\n      for (const [topic, msg] of this.retained) {\n        if (topics.some((p) => PanBus.matches(topic, p))) this._deliver(el, msg);\n      }\n    }\n  };\n\n  onUnsubscribe = (e) => {\n    const { topics = [], clientId } = e.detail || {};\n    const el = this._et(e);\n    this.subs = this.subs.filter((s) => {\n      const sameClient = clientId ? s.clientId === clientId : s.el === el;\n      return !(sameClient && topics.includes(s.pattern));\n    });\n  };\n\n  onPublish = (e) => {\n    const base = e.detail || {};\n    const msg = Object.assign({ ts: Date.now(), id: crypto.randomUUID() }, base);\n    if (msg.retain) this.retained.set(msg.topic, msg);\n    for (const s of this.subs) if (PanBus.matches(msg.topic, s.pattern)) this._deliver(s.el, msg);\n  };\n\n  onReply = (e) => {\n    const msg = e.detail || {};\n    for (const s of this.subs) if (PanBus.matches(msg.topic, s.pattern)) this._deliver(s.el, msg);\n  };\n\n  _deliver(target, msg) {\n    try { target.dispatchEvent(new CustomEvent('pan:deliver', { detail: msg })); } catch (_) { /* ignore */ }\n  }\n\n  _et(e) { return (typeof e.composedPath === 'function' ? e.composedPath()[0] : (e.target || document)); }\n\n  static matches(topic, pattern) {\n    if (pattern === '*' || topic === pattern) return true;\n    if (pattern && pattern.includes('*')) {\n      const esc = (s) => s.replace(/[|\\\\{}()\\[\\]^$+?.]/g, '\\\\$&').replace(/\\*/g, '[^.]+');\n      const rx = new RegExp(`^${esc(pattern)}$`);\n      return rx.test(topic);\n    }\n    return false;\n  }\n}\n\ncustomElements.define('pan-bus', PanBus);\nexport { PanBus };\nexport default PanBus;\n\n"],
  "mappings": "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",
  "names": []
}
