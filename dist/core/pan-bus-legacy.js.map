{
  "version": 3,
  "sources": ["../../src/core/pan-bus-legacy.mjs"],
  "sourcesContent": ["/**\n * @fileoverview PAN Bus - Central message bus for Page Area Network communication\n *\n * The PAN Bus is a custom element that provides publish/subscribe and request/reply\n * messaging via DOM CustomEvents. Messages bubble and are composed, crossing shadow DOM\n * boundaries for true component isolation.\n *\n * @example\n * // Add bus to page\n * <pan-bus></pan-bus>\n *\n * // Or wait for it to be ready\n * document.addEventListener('pan:sys.ready', () => {\n *   console.log('PAN bus is ready');\n * });\n */\n\n/**\n * @typedef {Object} PanMessage\n * @property {string} topic - Topic name (e.g., \"users.list.state\")\n * @property {*} data - Payload data (any JSON-serializable value)\n * @property {string} [id] - Unique message ID (UUID, auto-generated if not provided)\n * @property {number} [ts] - Timestamp in milliseconds (auto-generated if not provided)\n * @property {boolean} [retain] - If true, message is retained and replayed to new subscribers\n * @property {string} [replyTo] - Topic to send reply to (for request/reply pattern)\n * @property {string} [correlationId] - Correlation ID for request/reply matching\n * @property {Object} [headers] - Optional metadata headers\n */\n\n/**\n * @typedef {Object} Subscription\n * @property {string} pattern - Topic pattern to match (exact or wildcard with *)\n * @property {Element} el - Element that subscribed\n * @property {string} [clientId] - Optional client identifier\n * @property {boolean} [retained] - Whether to receive retained messages\n */\n\n/**\n * PAN Bus - Central message bus for Page Area Network\n *\n * Handles message routing between components using CustomEvents. Supports:\n * - Publish/subscribe pattern\n * - Request/reply pattern\n * - Retained messages (last message per topic)\n * - Topic wildcards (e.g., \"users.*\")\n * - Shadow DOM traversal\n *\n * @class\n * @extends HTMLElement\n */\nclass PanBus extends HTMLElement {\n  /**\n   * Creates a PAN Bus instance\n   * Initializes internal subscription list, retained message store, and client registry\n   */\n  constructor() {\n    super();\n\n    /**\n     * List of active subscriptions\n     * @type {Subscription[]}\n     * @private\n     */\n    this.subs = [];\n\n    /**\n     * Retained messages by topic\n     * @type {Map<string, PanMessage>}\n     * @private\n     */\n    this.retained = new Map();\n\n    /**\n     * Registered clients by ID\n     * @type {Map<string, {el: Element, caps: string[]}>}\n     * @private\n     */\n    this.clients = new Map();\n  }\n\n  /**\n   * Lifecycle: Called when element is added to the DOM\n   * Sets up event listeners in capture phase and announces readiness\n   * @private\n   */\n  connectedCallback() {\n    // capture listeners so bus observes events early in the capture phase\n    document.addEventListener('pan:publish', this.onPublish, true);\n    document.addEventListener('pan:request', this.onPublish, true);\n    document.addEventListener('pan:reply', this.onReply, true);\n    document.addEventListener('pan:subscribe', this.onSubscribe, true);\n    document.addEventListener('pan:unsubscribe', this.onUnsubscribe, true);\n    document.addEventListener('pan:hello', this.onHello, true);\n\n    // announce readiness\n    window.__panReady = true;\n    document.dispatchEvent(new CustomEvent('pan:sys.ready', { bubbles: true, composed: true }));\n  }\n\n  /**\n   * Lifecycle: Called when element is removed from the DOM\n   * Cleans up all event listeners\n   * @private\n   */\n  disconnectedCallback() {\n    document.removeEventListener('pan:publish', this.onPublish, true);\n    document.removeEventListener('pan:request', this.onPublish, true);\n    document.removeEventListener('pan:reply', this.onReply, true);\n    document.removeEventListener('pan:subscribe', this.onSubscribe, true);\n    document.removeEventListener('pan:unsubscribe', this.onUnsubscribe, true);\n    document.removeEventListener('pan:hello', this.onHello, true);\n  }\n\n  /**\n   * Handles client registration (pan:hello events)\n   * Clients can announce themselves with capabilities\n   *\n   * @param {CustomEvent} e - Hello event with {id, caps} in detail\n   * @private\n   */\n  onHello = (e) => {\n    const d = e.detail || {};\n    if (d.id) this.clients.set(d.id, { el: this._et(e), caps: d.caps || [] });\n  };\n\n  /**\n   * Handles subscription requests (pan:subscribe events)\n   * Adds subscriptions and optionally delivers retained messages\n   *\n   * @param {CustomEvent} e - Subscribe event with {topics, options, clientId} in detail\n   * @param {string[]} e.detail.topics - Array of topic patterns to subscribe to\n   * @param {Object} [e.detail.options] - Subscription options\n   * @param {boolean} [e.detail.options.retained] - Whether to receive retained messages\n   * @param {string} [e.detail.clientId] - Optional client identifier\n   * @private\n   */\n  onSubscribe = (e) => {\n    const { topics = [], options = {}, clientId } = e.detail || {};\n    const el = this._et(e);\n\n    // Add subscriptions\n    for (const pattern of topics) {\n      this.subs.push({ pattern, el, clientId, retained: !!options.retained });\n    }\n\n    // Deliver retained snapshots if requested\n    if (options.retained) {\n      for (const [topic, msg] of this.retained) {\n        if (topics.some((p) => PanBus.matches(topic, p))) {\n          this._deliver(el, msg);\n        }\n      }\n    }\n  };\n\n  /**\n   * Handles unsubscribe requests (pan:unsubscribe events)\n   * Removes matching subscriptions for the client\n   *\n   * @param {CustomEvent} e - Unsubscribe event with {topics, clientId} in detail\n   * @param {string[]} e.detail.topics - Array of topic patterns to unsubscribe from\n   * @param {string} [e.detail.clientId] - Optional client identifier\n   * @private\n   */\n  onUnsubscribe = (e) => {\n    const { topics = [], clientId } = e.detail || {};\n    const el = this._et(e);\n\n    this.subs = this.subs.filter((s) => {\n      const sameClient = clientId ? s.clientId === clientId : s.el === el;\n      return !(sameClient && topics.includes(s.pattern));\n    });\n  };\n\n  /**\n   * Handles publish and request events (pan:publish, pan:request)\n   * Routes message to all matching subscribers and optionally retains it\n   *\n   * @param {CustomEvent} e - Publish/request event with PanMessage in detail\n   * @param {string} e.detail.topic - Topic to publish on\n   * @param {*} e.detail.data - Message payload\n   * @param {boolean} [e.detail.retain] - Whether to retain this message\n   * @private\n   */\n  onPublish = (e) => {\n    const base = e.detail || {};\n\n    // Enhance message with timestamp and ID\n    const msg = Object.assign({\n      ts: Date.now(),\n      id: crypto.randomUUID()\n    }, base);\n\n    // Store retained message\n    if (msg.retain) {\n      this.retained.set(msg.topic, msg);\n    }\n\n    // Deliver to matching subscribers\n    for (const s of this.subs) {\n      if (PanBus.matches(msg.topic, s.pattern)) {\n        this._deliver(s.el, msg);\n      }\n    }\n  };\n\n  /**\n   * Handles reply events (pan:reply)\n   * Routes reply to subscribers waiting on the reply topic\n   *\n   * @param {CustomEvent} e - Reply event with PanMessage in detail\n   * @param {string} e.detail.topic - Reply topic (from replyTo)\n   * @param {*} e.detail.data - Reply payload\n   * @param {string} [e.detail.correlationId] - Correlation ID matching the request\n   * @private\n   */\n  onReply = (e) => {\n    const msg = e.detail || {};\n\n    // Deliver to matching subscribers\n    for (const s of this.subs) {\n      if (PanBus.matches(msg.topic, s.pattern)) {\n        this._deliver(s.el, msg);\n      }\n    }\n  };\n\n  /**\n   * Delivers a message to a target element\n   * Dispatches a pan:deliver CustomEvent on the target\n   *\n   * @param {Element} target - Element to deliver message to\n   * @param {PanMessage} msg - Message to deliver\n   * @private\n   */\n  _deliver(target, msg) {\n    try {\n      target.dispatchEvent(new CustomEvent('pan:deliver', { detail: msg }));\n    } catch (_) {\n      // Ignore delivery errors (element may have been removed)\n    }\n  }\n\n  /**\n   * Gets the event target, traversing composed path if available\n   * Handles shadow DOM traversal\n   *\n   * @param {Event} e - Event to get target from\n   * @returns {Element} The actual event target\n   * @private\n   */\n  _et(e) {\n    return (typeof e.composedPath === 'function'\n      ? e.composedPath()[0]\n      : (e.target || document));\n  }\n\n  /**\n   * Checks if a topic matches a pattern\n   * Supports exact match, single wildcard (*), or wildcard in pattern (users.*)\n   *\n   * @param {string} topic - Topic to test (e.g., \"users.list.state\")\n   * @param {string} pattern - Pattern to match against (e.g., \"users.*\" or \"users.list.state\")\n   * @returns {boolean} True if topic matches pattern\n   * @static\n   *\n   * @example\n   * PanBus.matches('users.list.state', 'users.*')  // true\n   * PanBus.matches('users.list.state', 'users.list.state')  // true\n   * PanBus.matches('users.list.state', '*')  // true\n   * PanBus.matches('users.list.state', 'posts.*')  // false\n   */\n  static matches(topic, pattern) {\n    // Exact match or global wildcard\n    if (pattern === '*' || topic === pattern) return true;\n\n    // Pattern contains wildcards - build regex\n    if (pattern && pattern.includes('*')) {\n      const esc = (s) => s.replace(/[|\\\\{}()\\[\\]^$+?.]/g, '\\\\$&').replace(/\\*/g, '[^.]+');\n      const rx = new RegExp(`^${esc(pattern)}$`);\n      return rx.test(topic);\n    }\n\n    return false;\n  }\n}\n\ncustomElements.define('pan-bus', PanBus);\nexport { PanBus };\nexport default PanBus;\n"],
  "mappings": "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",
  "names": []
}
